<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hệ thống Tồn Kho</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
:root {
    --primary-color: #4e73df;
    --success-color: #1cc88a;
    --info-color: #36b9cc;
    --warning-color: #f6c23e;
    --danger-color: #e74a3b;
    --nphp-color: #4CAF50;
    --cotloi-color: #FFC0CB;
    --khac-color: #FFA500;
    --light-bg: #f8f9fc;
    --sidebar-width: 250px;
    --mobile-card-shadow: 0 4px 12px rgba(0,0,0,0.1);
    --mobile-border-radius: 12px;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--light-bg);
    color: #5a5c69;
    overflow-x: hidden;
}

.navbar {
    background-color: var(--primary-color) !important;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.card {
    border: none;
    border-radius: 0.35rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    margin-bottom: 1.5rem;
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
    font-weight: 700;
    padding: 1rem;
}

/* CSS cho ô có thể sửa */
.editable-cell {
    cursor: pointer;
    position: relative;
    background-color: inherit !important;
    color: inherit !important;
    transition: background-color 0.3s;
}

.editable-cell:hover {
    background-color: rgba(255, 255, 255, 0.2) !important;
}

.editable-cell.editing {
    background-color: white !important;
    color: #333 !important;
    padding: 0;
}

.editable-cell input {
    width: 100%;
    border: 1px solid var(--primary-color);
    padding: 5px;
    text-align: center;
    background-color: white !important;
    color: #333 !important;
    border-radius: 4px;
}

.editable-cell .edit-icon {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: inherit;
    opacity: 0;
    transition: opacity 0.2s;
}

.editable-cell:hover .edit-icon {
    opacity: 0.8;
}

/* Màu sắc cho NCC */
.nphp {
    background-color: var(--nphp-color) !important;
    color: white !important;
}

.cotloi {
    background-color: var(--cotloi-color) !important;
}

.khac {
    background-color: var(--khac-color) !important;
}

/* Nút bấm */
.btn {
    border-radius: 0.35rem;
    font-weight: 600;
    padding: 0.5rem 1rem;
    transition: all 0.3s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
}

.btn-info {
    background-color: var(--info-color);
    border-color: var(--info-color);
}

.btn-warning {
    background-color: var(--warning-color);
    border-color: var(--warning-color);
}

.btn-danger {
    background-color: var(--danger-color);
    border-color: var(--danger-color);
}

.btn-secondary {
    background-color: #858796;
    border-color: #858796;
}

/* Container bao quanh bảng */
.table-responsive {
    overflow: auto;
    max-height: 70vh;
    border-radius: 0.35rem;
}

/* Các thuộc tính chung cho bảng */
#inventoryTable {
    border-collapse: collapse;
    width: 100%;
}

/* Cố định hàng tiêu đề */
#inventoryTable thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background-color: #f8f9fa;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    padding: 0.75rem;
}

/* Cố định 4 cột đầu tiên */
#inventoryTable th:nth-child(-n+4),
#inventoryTable td:nth-child(-n+4) {
    position: sticky;
    background-color: white;
    z-index: 1;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* Cố định vị trí các cột */
#inventoryTable th:nth-child(1),
#inventoryTable td:nth-child(1) {
    left: 0;
    min-width: 50px;
    width: 50px;
}

#inventoryTable th:nth-child(2),
#inventoryTable td:nth-child(2) {
    left: 50px;
    min-width: 80px;
    width: 80px;
}

#inventoryTable th:nth-child(3),
#inventoryTable td:nth-child(3) {
    left: 130px;
    min-width: 200px;
    width: 200px;
}

#inventoryTable th:nth-child(4),
#inventoryTable td:nth-child(4) {
    left: 330px;
    min-width: 80px;
    width: 80px;
}

/* Cố định ô góc trên cùng bên trái */
#inventoryTable thead th:nth-child(-n+4) {
    z-index: 3;
}

#inventoryTable th {
    min-width: 50px;
    text-align: center;
    white-space: nowrap;
    padding: 0.75rem;
}

#inventoryTable td {
    text-align: center;
    white-space: nowrap;
    padding: 0.5rem;
}

.modal-header {
    background-color: var(--primary-color);
    color: white;
    border-radius: 0.35rem 0.35rem 0 0;
}

.nav-tabs .nav-link {
    color: var(--primary-color);
    font-weight: 500;
    padding: 0.75rem 1rem;
    border-radius: 0.35rem 0.35rem 0 0;
    transition: all 0.3s;
}

.nav-tabs .nav-link.active {
    font-weight: bold;
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
    background-color: white;
}

.footer {
    margin-top: auto;
    padding: 20px 0;
    background-color: var(--light-bg);
    border-top: 1px solid #e3e6f0;
    text-align: center;
}
/* Căn lề trái cho cột Tên hàng trong bảng tồn kho */
#inventoryTable td:nth-child(3) {
    text-align: left !important;
    padding-left: 10px !important;
}

/* Đảm bảo cột Tên hàng trong phần header cũng căn lề trái */
#inventoryTable th:nth-child(3) {
    text-align: left !important;
    padding-left: 10px !important;
}
/* Cải thiện giao diện mobile cho bảng tồn kho */
@media (max-width: 576px) {
    /* Ẩn cột NCC và ĐVT */
    #inventoryTable th:nth-child(2),
    #inventoryTable td:nth-child(2),
    #inventoryTable th:nth-child(4),
    #inventoryTable td:nth-child(4) {
        display: none;
    }
    
    /* Điều chỉnh vị trí cột Tên hàng ngay cạnh STT */
    #inventoryTable th:nth-child(3),
    #inventoryTable td:nth-child(3) {
        left: 50px;
        min-width: 150px;
        width: 150px;
        padding-left: 8px !important;
    }
    
    /* Tăng chiều cao tối đa của bảng trên mobile */
    .table-responsive {
        max-height: 60vh;
    }
}

/* Cải thiện giao diện máy tính - mở rộng hơn */
@media (min-width: 1200px) {
    .container-fluid {
        max-width: 95%;
        margin: 0 auto;
    }
    
    .card {
        margin-bottom: 1.5rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .table-responsive {
        max-height: 75vh;
    }
    
    /* Tăng kích thước font cho máy tính */
    .table {
        font-size: 1rem;
    }
    
    .table th, .table td {
        padding: 0.75rem;
    }
}

/* Cải thiện modal nhập tồn kho */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-footer {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .modal-footer button {
        width: 100%;
    }
}

/* Cải thiện giao diện tab lên hàng */
@media (max-width: 768px) {
    #restockTable {
        font-size: 0.8rem;
    }
    
    #restockTable th, #restockTable td {
        padding: 0.5rem 0.3rem;
    }
    
    /* Điều chỉnh tổng tiền trên mobile */
    #restockTotalAmount {
        font-size: 1rem;
        font-weight: bold;
    }
}

    .mobile-modal .modal-content {
        border-radius: 15px;
    }
    
    .mobile-modal .modal-header {
        border-radius: 15px 15px 0 0;
        padding: 1rem;
    }
    
    .mobile-modal .modal-body {
        padding: 1.25rem;
    }
    
    .mobile-modal .modal-footer {
        border-radius: 0 0 15px 15px;
        padding: 1rem;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .mobile-modal .modal-footer .btn {
        width: 100%;
        padding: 0.75rem;
        font-weight: 600;
    }
    
    .mobile-modal .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .mobile-modal .form-control, .mobile-modal .form-select {
        border-radius: 8px;
        border: 1px solid #ced4da;
        padding: 0.75rem;
        font-size: 1rem;
    }
    
    .mobile-modal .form-control:focus, .mobile-modal .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    /* Cải thiện giao diện cho máy tính */
    @media (min-width: 768px) {
        .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            border-radius: 15px 15px 0 0;
            padding: 1.25rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-radius: 0 0 15px 15px;
            padding: 1.25rem;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 0.75rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #4e73df;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
    }
    


/* ===== MOBILE OPTIMIZATION ===== */
/* Mobile navigation improvements */
.navbar-brand {
    font-size: 1.2rem;
}
/* Mobile Inventory Styles */
.mobile-inventory-container {
    border: 1px solid #dee2e6;
    border-radius: 0.35rem;
    overflow: hidden;
}

.mobile-inventory-header {
    display: flex;
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
}

.mobile-product-name {
    width: 150px;
    padding: 10px;
    flex-shrink: 0;
    border-right: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mobile-days-container {
    display: flex;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
    -webkit-overflow-scrolling: touch; /* Cho cuộn mượt mà trên iOS */
}

.mobile-days-container::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
}

.mobile-day-header {
    width: 50px;
    min-width: 50px;
    padding: 10px 5px;
    text-align: center;
    border-right: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mobile-inventory-body {
    max-height: 60vh;
    overflow-y: auto;
}

.mobile-inventory-row {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    position: relative;
}

.mobile-inventory-row:last-child {
    border-bottom: none;
}

.mobile-product-cell {
    width: 150px;
    min-width: 150px;
    padding: 10px;
    flex-shrink: 0;
    border-right: 1px solid #dee2e6;
    font-weight: 500;
    position: sticky;
    left: 0;
    background-color: inherit;
    z-index: 5;
}

.mobile-days-data {
    display: flex;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
    -webkit-overflow-scrolling: touch; /* Cho cuộn mượt mà trên iOS */
}

.mobile-days-data::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
}

.mobile-day-cell {
    width: 50px;
    min-width: 50px;
    padding: 10px 5px;
    text-align: center;
    border-right: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

/* Đánh dấu ngày hiện tại */
.mobile-day-header.current-day,
.mobile-day-cell.current-day {
    background-color: #e3f2fd;
    font-weight: bold;
}

/* Màu nền cho các sản phẩm */
.mobile-inventory-row.nphp {
    background-color: var(--nphp-color) !important;
    color: rgb(1, 1, 1) !important;
}

.mobile-inventory-row.cotloi {
    background-color: var(--cotloi-color) !important;
}

.mobile-inventory-row.khac {
    background-color: var(--khac-color) !important;
}

/* Đảm bảo màu nền cho cột tên hàng */
.mobile-product-cell {
    background-color: inherit;
}

.navbar-toggler {
    border: none;
    padding: 0.25rem 0.5rem;
}

.navbar-toggler:focus {
    box-shadow: none;
}

/* Mobile tabs improvements */
.nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
}

.nav-tabs::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
}

.nav-tabs .nav-link {
    padding: 0.5rem;
    font-size: 0.8rem;
    min-width: 80px;
    text-align: center;
    justify-content: center;
}

/* Mobile card improvements */
.card {
    margin-bottom: 1rem;
    border-radius: var(--mobile-border-radius);
    box-shadow: var(--mobile-card-shadow);
}

.card-header {
    padding: 0.75rem;
    border-radius: var(--mobile-border-radius) var(--mobile-border-radius) 0 0 !important;
}

.card-header h3 {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
}

.card-header .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.5rem;
}

.card-header .btn {
    padding: 0.5rem 0.5rem;
    font-size: 0.75rem;
    flex: 1;
    min-width: 130px;
}

/* Mobile table improvements */
.table-responsive {
    border-radius: var(--mobile-border-radius);
    max-height: 50vh;
    font-size: 0.8rem;
}

.table {
    margin-bottom: 0;
}

.table th, .table td {
    padding: 0.4rem;
    font-size: 0.8rem;
}

/* Mobile form improvements */
.form-control, .form-select {
    font-size: 0.9rem;
    padding: 0.5rem;
    border-radius: 0.35rem;
}

.form-label {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

/* Mobile modal improvements */
.modal-dialog {
    margin: 1rem;
    max-width: calc(100% - 2rem);
}

.modal-content {
    border-radius: var(--mobile-border-radius);
}

.modal-header {
    padding: 0.75rem;
    border-radius: var(--mobile-border-radius) var(--mobile-border-radius) 0 0 !important;
}

.modal-title {
    font-size: 1.1rem;
}

.modal-body {
    padding: 1rem;
}

.modal-footer {
    padding: 0.75rem;
    border-top: 1px solid #e3e6f0;
}

/* Mobile button improvements */
.btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    border-radius: 0.35rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Mobile footer improvements */
.footer {
    padding: 1rem 0;
    font-size: 0.8rem;
}

/* ===== END MOBILE OPTIMIZATION ===== */

/* Responsive styles cho bảng tồn kho */
@media (max-width: 768px) {
    #inventoryTable th:nth-child(3),
    #inventoryTable td:nth-child(3) {
        min-width: 150px;
        width: 150px;
        left: 110px;
        padding-left: 8px !important;
    }
    
    #inventoryTable th:nth-child(4),
    #inventoryTable td:nth-child(4) {
        left: 260px;
        min-width: 60px;
        width: 60px;
    }
}

@media (max-width: 576px) {
    #inventoryTable th:nth-child(3),
    #inventoryTable td:nth-child(3) {
        min-width: 120px;
        width: 120px;
        left: 110px;
        padding-left: 6px !important;
    }
    
    #inventoryTable th:nth-child(2),
    #inventoryTable td:nth-child(2) {
        min-width: 60px;
        width: 60px;
    }
    
    #inventoryTable th:nth-child(4),
    #inventoryTable td:nth-child(4) {
        left: 230px;
        min-width: 50px;
        width: 50px;
    }
    
    /* Ẩn cột NCC và ĐVT trên mobile */
    #inventoryTable th:nth-child(2),
    #inventoryTable td:nth-child(2),
    #inventoryTable th:nth-child(4),
    #inventoryTable td:nth-child(4) {
        display: none;
    }
    
    /* Điều chỉnh vị trí cột Tên hàng khi ẩn cột NCC */
    #inventoryTable th:nth-child(3),
    #inventoryTable td:nth-child(3) {
        left: 50px;
    }
}

/* Autocomplete styles */
.autocomplete-dropdown {
    position: absolute;
    width: 200px;
    max-height: 200px;
    overflow-y: auto;
    background-color: white;
    border: 1px solid #ddd;
    z-index: 1000;
    display: none;
    border-radius: 4px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.autocomplete-item:hover {
    background-color: #f0f0f0;
}

/* Loading indicator */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* CSS cho tiêu đề bảng có hiệu ứng bóng */
.table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #f8f9fa;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-bottom: 2px solid #dee2e6;
}

/* Đảm bảo hiệu ứng bóng cho tất cả các bảng */
#inventoryTable thead th,
#importTable thead th,
#usageTable thead th,
#reportTable thead th,
#productTable thead th,
#restockTable thead th,
#userTable thead th,
#importListTable thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #f8f9fa;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-bottom: 2px solid #dee2e6;
}

/* Responsive styles */
@media (max-width: 768px) {
    .container-fluid {
        padding: 0.5rem;
    }
    
    .card {
        margin-bottom: 1rem;
    }
    
    .card-header {
        padding: 0.75rem;
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .card-header h3 {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }
    
    .card-header .btn-group {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
    }
    
    .table-responsive {
        max-height: 50vh;
    }
    
    #inventoryTable th:nth-child(3),
    #inventoryTable td:nth-child(3) {
        min-width: 150px;
        width: 150px;
    }
    
    #inventoryTable th:nth-child(4),
    #inventoryTable td:nth-child(4) {
        left: 230px;
    }
    
    .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .nav-tabs .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
    
    .modal-dialog {
        margin: 1rem;
        max-width: calc(100% - 2rem);
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .form-control, .form-select {
        font-size: 0.9rem;
    }
    
    .table td, .table th {
        padding: 0.4rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    .card-header h3 {
        font-size: 1rem;
    }
    
    .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
    }
    
    .table-responsive {
        max-height: 40vh;
    }
    
    #inventoryTable th:nth-child(2),
    #inventoryTable td:nth-child(2) {
        min-width: 60px;
        width: 60px;
    }
    
    #inventoryTable th:nth-child(3),
    #inventoryTable td:nth-child(3) {
        left: 110px;
        min-width: 120px;
        width: 120px;
    }
    
    #inventoryTable th:nth-child(4),
    #inventoryTable td:nth-child(4) {
        left: 230px;
        min-width: 60px;
        width: 60px;
    }
    
    .footer {
        font-size: 0.8rem;
        padding: 10px 0;
    }
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Toast notification */
.toast-container {
    z-index: 1055;
}

.toast {
    border-radius: 0.35rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    animation: fadeIn 0.5s ease-out;
}

/* Custom button styles */
.btn-group .btn {
    margin-right: 0.5rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

/* Table hover effects */
.table tbody tr {
    transition: background-color 0.2s;
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

/* Form control focus styles */
.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

/* Loading overlay */
#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

#loading-overlay .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3rem;
}

/* Progress bar styles */
.progress {
    height: 0.5rem;
    border-radius: 0.35rem;
}

.progress-bar {
    border-radius: 0.35rem;
    transition: width 0.6s ease;
}

/* Modal styles */
.modal-content {
    border-radius: 0.35rem;
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.modal-footer {
    border-top: 1px solid #e3e6f0;
    padding: 1rem;
}

/* Badge styles */
.badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
    border-radius: 0.35rem;
}

/* Alert styles */
.alert {
    border-radius: 0.35rem;
    border: none;
    padding: 0.75rem 1rem;
}

/* Input group styles */
.input-group-text {
    background-color: #f8f9fc;
    border-color: #d1d3e2;
}

/* Dropdown menu styles */
.dropdown-menu {
    border-radius: 0.35rem;
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.dropdown-item {
    padding: 0.5rem 1rem;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #f8f9fc;
}

/* Custom checkbox and radio styles */
.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-check-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

/* Pagination styles */
.page-link {
    color: var(--primary-color);
    border-radius: 0.35rem;
    margin: 0 2px;
}

.page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

/* Card image styles */
.card-img-top {
    border-radius: 0.35rem 0.35rem 0 0;
}

/* List group styles */
.list-group-item {
    border-color: #e3e6f0;
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: #f8f9fc;
}

/* Breadcrumb styles */
.breadcrumb {
    background-color: transparent;
    padding: 0.75rem 0;
}

.breadcrumb-item + .breadcrumb-item::before {
    color: #858796;
}

/* Accordion styles */
.accordion-button:not(.collapsed) {
    background-color: #f8f9fc;
    color: var(--primary-color);
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

/* Tooltip styles */
.tooltip {
    font-size: 0.875rem;
}

/* Popover styles */
.popover {
    border-radius: 0.35rem;
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

/* Carousel styles */
.carousel-control-prev,
.carousel-control-next {
    width: 5%;
}

.carousel-indicators li {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

/* Jumbotron styles */
.jumbotron {
    border-radius: 0.35rem;
    padding: 2rem;
}

/* Figure styles */
.figure-img {
    border-radius: 0.35rem;
}

/* Code styles */
pre {
    border-radius: 0.35rem;
}

/* Blockquote styles */
.blockquote {
    border-left: 4px solid var(--primary-color);
}

/* Custom utilities */
.text-primary {
    color: var(--primary-color) !important;
}

.bg-primary {
    background-color: var(--primary-color) !important;
}

.border-primary {
    border-color: var(--primary-color) !important;
}

/* Mobile-first responsive adjustments */
@media (max-width: 1200px) {
    .container-fluid {
        max-width: 100%;
    }
}

@media (max-width: 992px) {
    .navbar-expand-lg .navbar-nav {
        flex-direction: row;
    }
    
    .navbar-expand-lg .navbar-nav .nav-link {
        padding-right: 0.5rem;
        padding-left: 0.5rem;
    }
}

@media (max-width: 768px) {
    .d-flex.justify-content-between {
        flex-direction: column;
        align-items: stretch !important;
    }
    
    .d-flex.justify-content-between > * {
        margin-bottom: 0.5rem;
    }
    
    .card-header .btn-group {
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .modal-body {
        padding: 0.75rem;
    }
    
    .modal-footer {
        padding: 0.75rem;
    }
}

/* Print styles */
@media print {
    .navbar,
    .footer,
    .btn,
    .nav-tabs,
    .modal,
    .toast-container {
        display: none !important;
    }
    
    .card {
        box-shadow: none;
        border: 1px solid #ddd;
        break-inside: avoid;
    }
    
    .table-responsive {
        overflow: visible;
        max-height: none;
    }
    
    #inventoryTable thead th {
        position: static;
    }
    
    #inventoryTable th:nth-child(-n+4),
    #inventoryTable td:nth-child(-n+4) {
        position: static;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    :root {
        --primary-color: #0056b3;
        --success-color: #0a7c4a;
        --info-color: #0c7b93;
        --warning-color: #b8860b;
        --danger-color: #bd2130;
    }
    
    .card {
        border: 2px solid #333;
    }
    
    .btn {
        border-width: 2px;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* Focus visible for better accessibility */
:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Skip to main content link for accessibility */
.skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--primary-color);
    color: white;
    padding: 8px;
    z-index: 100;
    transition: top 0.3s;
}

.skip-link:focus {
    top: 0;
}
/* Login page styles */
#loginPage {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

#loginPage .card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
}

#loginPage .card-header {
    border: none;
}

#loginPage .form-control {
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 12px;
}

#loginPage .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

#loginPage .input-group-text {
    background-color: #f8f9fc;
    border: 1px solid #ddd;
    border-radius: 8px 0 0 8px;
}

#loginPage .btn {
    border-radius: 8px;
    padding: 12px;
    font-weight: 600;
}

#loginPage .input-group .form-control {
    border-radius: 0 8px 8px 0;
}

#loginPage .input-group .form-control:focus {
    z-index: 1;
}

#loginPage .input-group .input-group-text:focus {
    z-index: 2;
}
</style>
</head>
<body class="d-flex flex-column min-vh-100">
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Đăng nhập -->
<div id="loginPage" class="d-flex align-items-center justify-content-center min-vh-100">
    <div class="card shadow-lg" style="width: 400px;">
        <div class="card-header bg-primary text-white text-center py-3">
            <h4 class="mb-0"><i class="bi bi-box-seam me-2"></i>Hệ thống Tồn Kho</h4>
            <p class="mb-0 small">Đăng nhập để tiếp tục</p>
        </div>
        <div class="card-body p-4">
            <div class="mb-3">
                <label for="username" class="form-label">Tên đăng nhập</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                    <input type="text" class="form-control" id="username" placeholder="Nhập tên đăng nhập">
                </div>
            </div>
            <div class="mb-4">
                <label for="password" class="form-label">Mật khẩu</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-lock"></i></span>
                    <input type="password" class="form-control" id="password" placeholder="Nhập mật khẩu">
                </div>
            </div>
            <div class="d-grid">
                <button class="btn btn-primary" onclick="login()">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập
                </button>
            </div>
            <div id="loginError" class="alert alert-danger mt-3 d-none" role="alert">
                Tên đăng nhập hoặc mật khẩu không đúng!
            </div>
        </div>
        <div class="card-footer text-center text-muted py-3">
            <small>Hệ thống Quản lý tồn kho &copy; Sunday Basic Biên Hoà 2025</small>
        </div>
    </div>
</div>

<!-- Nội dung chính của ứng dụng -->
<div id="mainContent" class="d-none">
    <!-- Navbar và các tab -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-box-seam me-2 fs-4"></i>
                <span class="fw-bold">Hệ thống Tồn Kho</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span>Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Cài đặt</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid flex-grow-1 py-4" id="main-content">
        <!-- Navigation Tabs -->
        <div class="card mb-4">
            <div class="card-body p-0">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active d-flex align-items-center" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">
                            <i class="bi bi-archive me-2"></i>
                            <span class="d-none d-sm-inline">Tồn Kho</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link d-flex align-items-center" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button">
                            <i class="bi bi-box-arrow-in-right me-2"></i>
                            <span class="d-none d-sm-inline">Nhập Hàng</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link d-flex align-items-center" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" type="button">
                            <i class="bi bi-bar-chart me-2"></i>
                            <span class="d-none d-sm-inline">Sử Dụng</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link d-flex align-items-center" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            <span class="d-none d-sm-inline">Báo Cáo</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link d-flex align-items-center" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button">
                            <i class="bi bi-box me-2"></i>
                            <span class="d-none d-sm-inline">Hàng Hóa</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link d-flex align-items-center" id="restock-tab" data-bs-toggle="tab" data-bs-target="#restock" type="button">
                            <i class="bi bi-cart-plus me-2"></i>
                            <span class="d-none d-sm-inline">Lên Hàng</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link d-flex align-items-center" id="user-tab" data-bs-toggle="tab" data-bs-target="#user" type="button">
                            <i class="bi bi-people me-2"></i>
                            <span class="d-none d-sm-inline">Người Dùng</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Tồn Kho Tab -->
            <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <h3 class="m-0"><i class="bi bi-archive me-2"></i>TỒN KHO</h3>
                        <div class="btn-group flex-wrap justify-content-center mt-3 mt-md-0">
                            <button class="btn btn-info" onclick="document.getElementById('importInventoryFile').click()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Import
                            </button>
                            <input type="file" id="importInventoryFile" accept=".xlsx, .xls" style="display: none;" onchange="importInventoryFromExcel(this)">
                            <button class="btn btn-secondary" onclick="downloadInventoryTemplate()">
                                <i class="bi bi-download me-1"></i>Tải mẫu
                            </button>
                            <button class="btn btn-primary" onclick="showInventoryForm()">
                                <i class="bi bi-plus-circle me-1"></i>Tồn Kho
                            </button>
                            <button class="btn btn-success" onclick="exportInventoryToExcel()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Xuất Excel
                            </button>
                            <button class="btn btn-warning" onclick="showLyReportModal()">
                                <i class="bi bi-file-earmark-text me-1"></i>B.Cáo Ly
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Chọn tháng/năm -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="inventoryMonth" class="form-label">Chọn tháng/năm</label>
                                <input type="month" class="form-control" id="inventoryMonth" onchange="loadInventoryTable()">
                            </div>
                        </div>

                        <!-- Bảng tồn kho cho desktop -->
                        <div class="table-responsive d-none d-md-block">
                            <table class="table table-bordered table-hover" id="inventoryTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>NCC</th>
                                        <th>Tên hàng</th>
                                        <th>ĐVT</th>
                                        <th>Tồn đầu</th>
                                        <!-- Các ngày sẽ được thêm động -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Bảng tồn kho cho mobile -->
                        <div class="d-md-none">
                            <div class="mobile-inventory-container">
                                <div class="mobile-inventory-header">
                                    <div class="mobile-product-name">Tên hàng</div>
                                    <div class="mobile-days-container" id="mobileDaysHeader">
                                        <!-- Các ngày sẽ được thêm động -->
                                    </div>
                                </div>
                                <div class="mobile-inventory-body" id="mobileInventoryBody">
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nhập Hàng Tab -->
            <div class="tab-pane fade" id="import" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <h3 class="m-0"><i class="bi bi-box-arrow-in-right me-2"></i>NHẬP HÀNG</h3>
                        <div class="btn-group flex-wrap justify-content-center mt-3 mt-md-0">
                            <button class="btn btn-info" onclick="document.getElementById('importImportFile').click()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Import
                            </button>
                            <input type="file" id="importImportFile" accept=".xlsx, .xls" style="display: none;" onchange="importImportFromExcel(this)">
                            <button class="btn btn-secondary" onclick="downloadImportTemplate()">
                                <i class="bi bi-download me-1"></i>Tải mẫu
                            </button>
                            <button class="btn btn-info" onclick="showImportList()">
                                <i class="bi bi-list-ul me-1"></i>Xem DS Nhập
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="importDate" class="form-label">Ngày nhập</label>
                                <input type="date" class="form-control" id="importDate">
                            </div>
                        </div>
                        <div class="d-flex flex-column flex-md-row justify-content-between mt-3">
                            <button class="btn btn-primary mb-2 mb-md-0" onclick="addImportRow()">
                                <i class="bi bi-plus-circle me-1"></i> Thêm dòng
                            </button>
                            <button class="btn btn-success" onclick="saveImport()">
                                <i class="bi bi-save me-1"></i>Lưu
                            </button>
                        </div>
                        <div class="mb-3"></div>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="importTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Tên hàng</th>
                                        <th>Số lượng</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 10 dòng mặc định -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sử Dụng Tab -->
            <div class="tab-pane fade" id="usage" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3 class="m-0"><i class="bi bi-bar-chart me-2"></i>SỬ DỤNG HÀNG HÓA</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="usageDate" class="form-label">Chọn ngày</label>
                                <input type="date" class="form-control" id="usageDate" onchange="loadUsageTable()">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="usageTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>NCC</th>
                                        <th>Tên hàng</th>
                                        <th>Tồn đầu tháng</th>
                                        <th>Tồn cuối ngày</th>
                                        <th>Nhập</th>
                                        <th>Sử dụng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Báo Cáo Tab -->
            <div class="tab-pane fade" id="report" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3 class="m-0"><i class="bi bi-file-earmark-text me-2"></i>BÁO CÁO</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reportType" id="dailyReport" value="daily" checked onchange="toggleReportType()">
                                    <label class="form-check-label" for="dailyReport">Theo ngày</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reportType" id="monthlyReport" value="monthly" onchange="toggleReportType()">
                                    <label class="form-check-label" for="monthlyReport">Theo tháng</label>
                                </div>
                            </div>
                            <div class="col-md-4" id="dailyReportDiv">
                                <label for="reportDate" class="form-label">Chọn ngày</label>
                                <input type="date" class="form-control" id="reportDate" onchange="loadReportTable()">
                            </div>
                            <div class="col-md-4" id="monthlyReportDiv" style="display: none;">
                                <label for="reportMonth" class="form-label">Chọn tháng/năm</label>
                                <input type="month" class="form-control" id="reportMonth" onchange="loadReportTable()">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="reportTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>NCC</th>
                                        <th>Tên hàng</th>
                                        <th>ĐVT</th>
                                        <th>Tồn trước</th>
                                        <th>Tồn sau</th>
                                        <th>Nhập</th>
                                        <th>Sử dụng</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="8" class="text-end fw-bold">Tổng tiền:</td>
                                        <td id="totalAmount" class="fw-bold">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="d-flex justify-content-end mt-3">
                            <button class="btn btn-success" onclick="exportReportToExcel()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Xuất Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quản Lý Hàng Hóa Tab -->
            <div class="tab-pane fade" id="product" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <h3 class="m-0"><i class="bi bi-box me-2"></i>QUẢN LÝ HÀNG HÓA</h3>
                        <div class="btn-group flex-wrap justify-content-center mt-3 mt-md-0">
                            <button class="btn btn-danger" onclick="showDeleteDataModal()">
                                <i class="bi bi-trash me-1"></i>Xóa Hết
                            </button>
                            <button class="btn btn-warning" onclick="saveProductOrder()">
                                <i class="bi bi-save me-1"></i>Lưu vị trí
                            </button>
                            <button class="btn btn-secondary" onclick="downloadProductTemplate()">
                                <i class="bi bi-download me-1"></i>Tải mẫu
                            </button>
                            <button class="btn btn-info" onclick="document.getElementById('importProductFile').click()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Import
                            </button>
                            <input type="file" id="importProductFile" accept=".xlsx, .xls" style="display: none;" onchange="importProductsFromExcel(this)">
                            <button class="btn btn-primary" onclick="showAddProductForm()">
                                <i class="bi bi-plus-circle me-1"></i>Thêm hàng hóa
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="productTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>NCC</th>
                                        <th>Tên hàng</th>
                                        <th>ĐVT</th>
                                        <th>Tồn tối thiểu</th>
                                        <th>Giá</th>
                                        <th>Màu NCC</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lên Hàng Tab -->
            <div class="tab-pane fade" id="restock" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <h3 class="m-0"><i class="bi bi-cart-plus me-2"></i>LÊN HÀNG</h3>
                        <div class="btn-group flex-wrap justify-content-center mt-3 mt-md-0">
                            <button class="btn btn-primary" onclick="generateRestockList()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Tạo DS lên hàng
                            </button>
                            <button class="btn btn-info" onclick="addRestockItem()">
                                <i class="bi bi-plus-circle me-1"></i>Thêm hàng
                            </button>
                            <button class="btn btn-success" onclick="exportRestockToExcel()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Xuất Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="restockDate" class="form-label">Chọn ngày</label>
                                <input type="date" class="form-control" id="restockDate" onchange="updateRestockDate()">
                            </div>
                            <div class="col-md-3">
                                <label for="restockNcc" class="form-label">Lọc theo NCC</label>
                                <select class="form-select" id="restockNcc" onchange="filterRestockByNcc()">
                                    <option value="">Tất cả</option>
                                    <option value="NPHP">NPHP</option>
                                    <option value="CỐT LÕI">CỐT LÕI</option>
                                    <option value="KHÁC">KHÁC</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="restockTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>NCC</th>
                                        <th>Tên hàng</th>
                                        <th>Tồn hiện tại</th>
                                        <th>Tồn tối thiểu</th>
                                        <th>Giá</th>
                                        <th>Cần đặt</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="7" class="text-end fw-bold">Tổng tiền:</td>
                                        <td id="restockTotalAmount" class="fw-bold">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quản Lý Người Dùng Tab -->
            <div class="tab-pane fade" id="user" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <h3 class="m-0"><i class="bi bi-people me-2"></i>QUẢN LÝ NGƯỜI DÙNG</h3>
                        <div class="btn-group flex-wrap justify-content-center mt-3 mt-md-0">
                            <button class="btn btn-primary" onclick="showAddUserForm()">
                                <i class="bi bi-plus-circle me-1"></i>Thêm người dùng
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="userTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Tên đăng nhập</th>
                                        <th>Mật khẩu</th>
                                        <th>Quyền</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dữ liệu sẽ được thêm động -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container-fluid">
            <div class="d-flex flex-column flex-md-row align-items-center justify-content-between small">
                <div class="text-muted mb-2 mb-md-0">Hệ thống Quản lý tồn kho &copy; Sunday Basic Biên Hoà 2025</div>
            </div>
        </div>
    </footer>
</div>
</div>

<!-- Modal nhập tồn kho -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Nhập Tồn Kho</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="productName" class="form-label">Tên hàng</label>
                    <select class="form-select" id="productName" onchange="updateProductInfo()">
                        <option value="">-- Chọn sản phẩm --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="unit" class="form-label">ĐVT</label>
                    <input type="text" class="form-control" id="unit" readonly>
                </div>
                <div class="mb-3">
                    <label for="previousInventory" class="form-label">Tồn trước</label>
                    <input type="text" class="form-control" id="previousInventory" readonly>
                </div>
                <div class="mb-3">
                    <label for="todayInventory" class="form-label">Tồn hôm nay</label>
                    <input type="number" class="form-control" id="todayInventory" placeholder="Nhập số lượng tồn">
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <button type="button" class="btn btn-secondary" onclick="previousProduct()">
                        <i class="bi bi-arrow-left me-1"></i>Mã trước
                    </button>
                    <div>
                        <button type="button" class="btn btn-primary me-2" onclick="saveAndContinue()">
                            <i class="bi bi-save me-1"></i>Lưu & Tiếp
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Thoát
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="nextProduct()">
                        Mã tiếp<i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal xem danh sách nhập hàng -->
<div class="modal fade" id="importListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-list-ul me-2"></i>Danh Sách Nhập Hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="filterImportDate" class="form-label">Lọc theo ngày</label>
                        <input type="date" class="form-control" id="filterImportDate" onchange="filterImportList()">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered" id="importListTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên hàng</th>
                                <th>Ngày nhập</th>
                                <th>Số lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dữ liệu sẽ được thêm động -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" onclick="exportImportToExcel()">
                    <i class="bi bi-file-earmark-excel me-1"></i>Xuất Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm/sửa hàng hóa -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle"><i class="bi bi-box me-2"></i>Thêm Hàng Hóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="productId">
                <div class="mb-3">
                    <label for="productNcc" class="form-label">NCC</label>
                    <select class="form-select" id="productNcc">
                        <option value="NPHP">NPHP</option>
                        <option value="CỐT LÕI">CỐT LÕI</option>
                        <option value="KHÁC">KHÁC</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="productTenHang" class="form-label">Tên hàng</label>
                    <input type="text" class="form-control" id="productTenHang" placeholder="Nhập tên hàng">
                </div>
                <div class="mb-3">
                    <label for="productDvt" class="form-label">ĐVT</label>
                    <input type="text" class="form-control" id="productDvt" placeholder="Nhập đơn vị tính">
                </div>
                <div class="mb-3">
                    <label for="productTonToiThieu" class="form-label">Tồn tối thiểu</label>
                    <input type="number" class="form-control" id="productTonToiThieu" placeholder="Nhập tồn tối thiểu">
                </div>
                <div class="mb-3">
                    <label for="productGia" class="form-label">Giá</label>
                    <input type="number" class="form-control" id="productGia" placeholder="Nhập giá">
                </div>
                <div class="mb-3">
                    <label for="productMauNcc" class="form-label">Màu NCC</label>
                    <input type="color" class="form-control form-control-color" id="productMauNcc" value="#4CAF50">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm/sửa người dùng -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle"><i class="bi bi-person-plus me-2"></i>Thêm Người Dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId">
                <div class="mb-3">
                    <label for="userTenDangNhap" class="form-label">Tên đăng nhập</label>
                    <input type="text" class="form-control" id="userTenDangNhap" placeholder="Nhập tên đăng nhập">
                </div>
                <div class="mb-3">
                    <label for="userMatKhau" class="form-label">Mật khẩu</label>
                    <input type="password" class="form-control" id="userMatKhau" placeholder="Nhập mật khẩu">
                </div>
                <div class="mb-3">
                    <label for="userQuyen" class="form-label">Quyền</label>
                    <select class="form-select" id="userQuyen">
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm mặt hàng vào danh sách lên hàng -->
<div class="modal fade" id="addRestockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cart-plus me-2"></i>Thêm Hàng Cần Lên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="restockProductId" class="form-label">Sản phẩm</label>
                    <select class="form-select" id="restockProductId">
                        <option value="">-- Chọn sản phẩm --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="restockQuantity" class="form-label">Số lượng cần đặt</label>
                    <input type="number" class="form-control" id="restockQuantity" placeholder="Nhập số lượng">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveAndAddRestockItem()">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị tiến trình import -->
<div class="modal fade" id="importProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel me-2"></i>Import Sản Phẩm</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Tiến trình:</span>
                        <span id="importProgressText">0/0</span>
                    </div>
                    <div class="progress">
                        <div id="importProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
                <div id="importStatus" class="alert alert-info">
                    Đang chuẩn bị import...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" disabled>Đang xử lý...</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận xóa dữ liệu -->
<div class="modal fade" id="deleteDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Xóa Dữ Liệu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác. Dữ liệu bị xóa sẽ không thể phục hồi.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Chọn dữ liệu cần xóa:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteAllOption" value="all">
                        <label class="form-check-label" for="deleteAllOption">
                            <strong>Xóa toàn bộ dữ liệu</strong> (sản phẩm và tồn kho)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteByNccOption" value="ncc" checked>
                        <label class="form-check-label" for="deleteByNccOption">
                            <strong>Xóa theo NCC</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteProductsOnlyOption" value="products">
                        <label class="form-check-label" for="deleteProductsOnlyOption">
                            <strong>Chỉ xóa sản phẩm</strong> (giữ lại dữ liệu tồn kho)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteInventoryOnlyOption" value="inventory">
                        <label class="form-check-label" for="deleteInventoryOnlyOption">
                            <strong>Chỉ xóa tồn kho</strong> (giữ lại sản phẩm)
                        </label>
                    </div>
                </div>
                
                <div id="nccSelection" class="mb-3">
                    <label for="nccSelect" class="form-label">Chọn NCC:</label>
                    <select class="form-select" id="nccSelect">
                        <option value="">-- Chọn NCC --</option>
                        <option value="NPHP">NPHP</option>
                        <option value="CỐT LÕI">CỐT LÕI</option>
                        <option value="KHÁC">KHÁC</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDelete">
                        <label class="form-check-label" for="confirmDelete">
                            Tôi xác nhận muốn xóa dữ liệu và hiểu rằng hành động này không thể hoàn tác
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton" disabled>Xóa dữ liệu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị tiến trình import tồn kho -->
<div class="modal fade" id="importInventoryProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel me-2"></i>Import Tồn Kho</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Tiến trình:</span>
                        <span id="importInventoryProgressText">0/0</span>
                    </div>
                    <div class="progress">
                        <div id="importInventoryProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
                <div id="importInventoryStatus" class="alert alert-info">
                    Đang chuẩn bị import...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" disabled>Đang xử lý...</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận cách xử lý dữ liệu trùng -->
<div class="modal fade" id="importInventoryOptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-question-circle me-2"></i>Xử lý dữ liệu trùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Phát hiện dữ liệu tồn kho trong file Excel đã tồn tại trong hệ thống. Bạn muốn:</p>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="inventoryDuplicateOption" id="inventoryUpdateOption" value="update" checked>
                    <label class="form-check-label" for="inventoryUpdateOption">
                        <strong>Cập nhật</strong> dữ liệu đã tồn tại
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="inventoryDuplicateOption" id="inventorySkipOption" value="skip">
                    <label class="form-check-label" for="inventorySkipOption">
                        <strong>Bỏ qua</strong> dữ liệu đã tồn tại
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="inventoryDuplicateOption" id="inventoryOverwriteOption" value="overwrite">
                    <label class="form-check-label" for="inventoryOverwriteOption">
                        <strong>Ghi đè</strong> tất cả dữ liệu trong khoảng thời gian
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmInventoryImportOption">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị tiến trình import nhập hàng -->
<div class="modal fade" id="importImportProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel me-2"></i>Import Nhập Hàng</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Tiến trình:</span>
                        <span id="importImportProgressText">0/0</span>
                    </div>
                    <div class="progress">
                        <div id="importImportProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
                <div id="importImportStatus" class="alert alert-info">
                    Đang chuẩn bị import...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" disabled>Đang xử lý...</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Báo Cáo Ly -->
<div class="modal fade" id="lyReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Báo Cáo Tồn Kho Ly</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="lyReportDate" class="form-label">Chọn ngày</label>
                        <input type="date" class="form-control" id="lyReportDate" onchange="loadLyReport()">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered" id="lyReportTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên Hàng</th>
                                <th>Tồn Trước</th>
                                <th>Tồn Nay</th>
                                <th>Sử dụng</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dữ liệu sẽ được thêm động -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                
            </div>
        </div>
    </div>
</div>

</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// Global variables
let products = [];
let inventoryData = [];
let importData = [];
let users = [];
let restockList = [];
let currentProductIndex = 0;
let currentMonth = new Date().getMonth() + 1;
let currentYear = new Date().getFullYear();
let currentUser = null; // Lưu thông tin người dùng hiện tại

// Thay thế URL này bằng URL Cloudflare Worker của bạn
const API_BASE_URL = 'http://localhost:3008/api';

document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
});

// Kiểm tra trạng thái đăng nhập
function checkLoginStatus() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            showMainContent();
            initializeApp();
        } catch (error) {
            console.error('Lỗi khi đọc thông tin người dùng:', error);
            localStorage.removeItem('currentUser');
            showLoginPage();
        }
    } else {
        showLoginPage();
    }
}

// Hiển thị trang đăng nhập
function showLoginPage() {
    document.getElementById('loginPage').classList.remove('d-none');
    document.getElementById('mainContent').classList.add('d-none');
}

// Hiển thị nội dung chính
function showMainContent() {
    document.getElementById('loginPage').classList.add('d-none');
    document.getElementById('mainContent').classList.remove('d-none');
    
    // Cập nhật tên người dùng trong navbar
    if (currentUser) {
        document.querySelector('#userDropdown span').textContent = currentUser.ten_dang_nhap;
    }
    
    // Phân quyền hiển thị tab và chức năng
    applyUserPermissions();
}

// Đăng nhập
async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const loginError = document.getElementById('loginError');
    
    if (!username || !password) {
        loginError.textContent = 'Vui lòng nhập tên đăng nhập và mật khẩu!';
        loginError.classList.remove('d-none');
        return;
    }
    
    try {
        showLoading();
        
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ten_dang_nhap: username,
                mat_khau: password
            })
        });
        
        if (response.ok) {
            const user = await response.json();
            currentUser = user;
            
            // Lưu thông tin người dùng vào localStorage
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // Hiển thị nội dung chính
            showMainContent();
            
            // Khởi tạo ứng dụng
            initializeApp();
        } else {
            const errorData = await response.json();
            loginError.textContent = errorData.error || 'Tên đăng nhập hoặc mật khẩu không đúng!';
            loginError.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error logging in:', error);
        loginError.textContent = 'Lỗi khi đăng nhập. Vui lòng thử lại sau!';
        loginError.classList.remove('d-none');
    } finally {
        hideLoading();
    }
}

// Đăng xuất
function logout() {
    localStorage.removeItem('currentUser');
    currentUser = null;
    showLoginPage();
    
    // Reset form đăng nhập
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('loginError').classList.add('d-none');
}

// Áp dụng phân quyền cho người dùng
function applyUserPermissions() {
    if (!currentUser) return;
    
    // Ẩn tất cả các tab trước
    const tabs = document.querySelectorAll('#mainTabs .nav-item');
    tabs.forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Hiển thị tab theo quyền
    if (currentUser.quyen === 'admin') {
        // Admin: Hiển thị tất cả các tab
        tabs.forEach(tab => {
            tab.style.display = '';
        });
    } else if (currentUser.quyen === 'user') {
        // User: Chỉ hiển thị tab Tồn Kho và Sử Dụng
        const inventoryTab = document.querySelector('#inventory-tab').parentElement;
        const usageTab = document.querySelector('#usage-tab').parentElement;
        
        inventoryTab.style.display = '';
        usageTab.style.display = '';
        
        // Mặc định chọn tab Tồn Kho
        const inventoryTabButton = document.querySelector('#inventory-tab');
        const inventoryTabPane = document.querySelector('#inventory');
        
        // Xóa active tất cả các tab
        document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active');
        });
        
        // Active tab Tồn Kho
        inventoryTabButton.classList.add('active');
        inventoryTabPane.classList.add('show', 'active');
        
        // Ẩn các nút không cần thiết trong tab Tồn Kho
        setTimeout(() => {
            const inventoryButtons = document.querySelector('#inventory .card-header .btn-group');
            if (inventoryButtons) {
                // Ẩn tất cả các nút
                Array.from(inventoryButtons.children).forEach(button => {
                    button.style.display = 'none';
                });
                
                // Chỉ hiển thị nút "Tồn Kho" và "B.Cáo Ly"
                const tonKhoButton = Array.from(inventoryButtons.children).find(btn => 
                    btn.textContent.includes('Tồn Kho')
                );
                const baoCaoLyButton = Array.from(inventoryButtons.children).find(btn => 
                    btn.textContent.includes('B.Cáo Ly')
                );
                
                if (tonKhoButton) tonKhoButton.style.display = '';
                if (baoCaoLyButton) baoCaoLyButton.style.display = '';
            }
        }, 100);
    }
}

// Xử lý sự kiện đăng xuất
document.addEventListener('DOMContentLoaded', function() {
    // Thêm sự kiện cho nút đăng xuất trong dropdown
    const logoutLink = document.querySelector('a[href="#"]:last-child');
    if (logoutLink && logoutLink.textContent.includes('Đăng xuất')) {
        logoutLink.addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });
    }
});

// Hàm kiểm tra quyền admin
function requireAdmin() {
    if (!currentUser || currentUser.quyen !== 'admin') {
        showErrorToast('Bạn không có quyền thực hiện chức năng này!');
        return false;
    }
    return true;
}

// Hàm kiểm tra quyền user
function requireUser() {
    if (!currentUser) {
        showErrorToast('Vui lòng đăng nhập để sử dụng chức năng này!');
        return false;
    }
    return true;
}

// Khởi tạo ứng dụng
async function initializeApp() {
    try {
        // Hiển thị loading
        showLoading();
        
        // Tải dữ liệu cơ bản
        await loadProducts();
        await loadUsers();
        
        // Thiết lập ngày/tháng hiện tại
        setCurrentDate();
        setCurrentMonth();
        
        // Khởi tạo ngày cho tab Lên Hàng
        initRestockDate();
        
        // Thiết lập các bảng
        setupImportTable();
        await loadInventoryTable(); // Đảm bảo đợi tải xong bảng tồn kho
        loadProductTable();
        loadUserTable();
        
        // Cập nhật dropdown sản phẩm trong modal thêm hàng lên hàng
        updateRestockProductDropdown();
        
        // Thêm sự kiện khi chuyển tab
        setupTabEvents();
        
        // Ẩn loading
        hideLoading();
    } catch (error) {
        console.error('Lỗi khởi tạo ứng dụng:', error);
        showErrorToast('Lỗi khi khởi tạo ứng dụng. Vui lòng tải lại trang.');
        hideLoading();
    }
}

// Cập nhật ngày cho tab Lên Hàng
function updateRestockDate() {
    const restockDate = document.getElementById('restockDate').value;
    if (restockDate) {
        // Lưu ngày đã chọn vào localStorage để sử dụng lần sau
        localStorage.setItem('restockDate', restockDate);
    }
}

// Khởi tạo ngày mặc định cho tab Lên Hàng
function initRestockDate() {
    const restockDateInput = document.getElementById('restockDate');
    
    // Thử lấy ngày đã lưu từ localStorage
    const savedDate = localStorage.getItem('restockDate');
    
    if (savedDate) {
        restockDateInput.value = savedDate;
    } else {
        // Nếu không có ngày đã lưu, sử dụng ngày hiện tại
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        restockDateInput.value = formattedDate;
    }
}

// Hiển thị loading
function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.style.position = 'fixed';
    loadingDiv.style.top = '0';
    loadingDiv.style.left = '0';
    loadingDiv.style.width = '100%';
    loadingDiv.style.height = '100%';
    loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
    loadingDiv.style.display = 'flex';
    loadingDiv.style.justifyContent = 'center';
    loadingDiv.style.alignItems = 'center';
    loadingDiv.style.zIndex = '9999';
    loadingDiv.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
    document.body.appendChild(loadingDiv);
}

// Ẩn loading
function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// Thiết lập sự kiện cho các tab
function setupTabEvents() {
    // Tab Sử Dụng
    document.getElementById('usage-tab').addEventListener('shown.bs.tab', function() {
        // Thiết lập ngày hiện tại nếu chưa có
        const usageDate = document.getElementById('usageDate');
        if (!usageDate.value) {
            const today = new Date();
            usageDate.value = today.toISOString().split('T')[0];
        }
        loadUsageTable();
    });

    // Tab Báo Cáo
    document.getElementById('report-tab').addEventListener('shown.bs.tab', function() {
        // Thiết lập ngày hiện tại nếu chưa có
        const reportDate = document.getElementById('reportDate');
        if (!reportDate.value) {
            const today = new Date();
            reportDate.value = today.toISOString().split('T')[0];
        }
        loadReportTable();
    });

    // Tab Quản Lý Hàng Hóa
    document.getElementById('product-tab').addEventListener('shown.bs.tab', function() {
        loadProducts().then(() => {
            loadProductTable();
        });
    });
    
    // Tab Lên Hàng
    document.getElementById('restock-tab').addEventListener('shown.bs.tab', function() {
        // Khởi tạo ngày nếu chưa có
        initRestockDate();
    });
}

// Thêm modal cho chức năng thêm hàng lên hàng
function addRestockModalHTML() {
    const modalHTML = `
    <!-- Modal thêm mặt hàng vào danh sách lên hàng -->
    <div class="modal fade" id="addRestockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cart-plus me-2"></i>Thêm Hàng Cần Lên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="restockProductId" class="form-label">Sản phẩm</label>
                        <select class="form-select" id="restockProductId">
                            <option value="">-- Chọn sản phẩm --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="restockQuantity" class="form-label">Số lượng cần đặt</label>
                        <input type="number" class="form-control" id="restockQuantity" placeholder="Nhập số lượng">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndAddRestockItem()">Thêm</button>
                </div>
            </div>
        </div>
    </div>
    `;

    // Thêm modal vào body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Cập nhật dropdown sản phẩm trong modal thêm hàng lên hàng
function updateRestockProductDropdown() {
    const dropdown = document.getElementById('restockProductId');
    if (!dropdown) return;

    dropdown.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';

    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product[0]; // ID
        option.textContent = product[2]; // TenHang
        dropdown.appendChild(option);
    });
}

// Thiết lập ngày hiện tại
function setCurrentDate() {
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('importDate').value = formattedDate;
    document.getElementById('usageDate').value = formattedDate;
    document.getElementById('reportDate').value = formattedDate;
}

// Thiết lập tháng hiện tại
function setCurrentMonth() {
    const today = new Date();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const currentMonthYear = `${year}-${month}`;
    
    const inventoryMonthSelect = document.getElementById('inventoryMonth');
    if (inventoryMonthSelect) {
        inventoryMonthSelect.value = currentMonthYear;
        console.log('Đã thiết lập tháng/năm hiện tại:', currentMonthYear); // Debug log
    }
    
    const reportMonthSelect = document.getElementById('reportMonth');
    if (reportMonthSelect) {
        reportMonthSelect.value = currentMonthYear;
    }
}

// Load danh sách sản phẩm
async function loadProducts() {
    try {
        const response = await fetch(`${API_BASE_URL}/products`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải danh sách sản phẩm');
        }
        products = await response.json();
        
        // Cập nhật dropdown trong modal tồn kho
        updateProductDropdown();
        
        // Cập nhật dropdown sản phẩm trong modal thêm hàng lên hàng
        updateRestockProductDropdown();
        
        // Cập nhật lại bảng tồn kho nếu đang hiển thị
        const inventoryTab = document.getElementById('inventory-tab');
        if (inventoryTab.classList.contains('active')) {
            loadInventoryTable();
        }
    } catch (error) {
        console.error('Error loading products:', error);
        throw error;
    }
}

// Load danh sách người dùng
async function loadUsers() {
    try {
        const response = await fetch(`${API_BASE_URL}/users`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải danh sách người dùng');
        }
        users = await response.json();
    } catch (error) {
        console.error('Error loading users:', error);
        throw error;
    }
}

// Cập nhật dropdown sản phẩm
function updateProductDropdown() {
    const dropdown = document.getElementById('productName');
    if (!dropdown) return;

    dropdown.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';

    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product[2]; // TenHang
        option.textContent = product[2]; // TenHang
        dropdown.appendChild(option);
    });

    // Chọn sản phẩm đầu tiên
    if (products.length > 0) {
        currentProductIndex = 0;
    }
}

// Load bảng tồn kho theo tháng
async function loadInventoryTable() {
    const monthYear = document.getElementById('inventoryMonth').value;
    if (!monthYear) return;

    const [year, month] = monthYear.split('-');
    currentMonth = parseInt(month);
    currentYear = parseInt(year);

    // Lấy số ngày trong tháng
    const daysInMonth = new Date(year, month, 0).getDate();

    // Lấy ngày hiện tại
    const currentDate = new Date();
    const currentDay = currentDate.getDate();
    const currentMonthNum = currentDate.getMonth() + 1;
    const currentYearNum = currentDate.getFullYear();

    try {
        // Lấy tất cả dữ liệu tồn kho
        const response = await fetch(`${API_BASE_URL}/inventory`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho');
        }
        inventoryData = await response.json();

        // Tạo header bảng desktop
        const headerRow = document.querySelector('#inventoryTable thead tr');
        // Xóa các cột ngày cũ (trừ 5 cột đầu: STT, NCC, Tên hàng, ĐVT, Tồn đầu)
        while (headerRow.children.length > 5) {
            headerRow.removeChild(headerRow.lastChild);
        }

        // Thêm cột ngày cho desktop
        for (let day = 1; day <= daysInMonth; day++) {
            const th = document.createElement('th');
            th.textContent = day;

            // Đánh dấu ngày hiện tại
            if (year == currentYearNum && month == currentMonthNum && day == currentDay) {
                th.style.backgroundColor = '#e3f2fd';
                th.style.fontWeight = 'bold';
            }

            headerRow.appendChild(th);
        }

        // Tạo body bảng desktop
        const tbody = document.querySelector('#inventoryTable tbody');
        tbody.innerHTML = '';

        // Tạo header cho mobile
        const mobileDaysHeader = document.getElementById('mobileDaysHeader');
        if (mobileDaysHeader) {
            mobileDaysHeader.innerHTML = '';
            
            // Thêm cột ngày cho mobile
            for (let day = 1; day <= daysInMonth; day++) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'mobile-day-header';
                dayHeader.textContent = day;

                // Đánh dấu ngày hiện tại
                if (year == currentYearNum && month == currentMonthNum && day == currentDay) {
                    dayHeader.classList.add('current-day');
                }

                mobileDaysHeader.appendChild(dayHeader);
            }
        }

        // Tạo body cho mobile
        const mobileInventoryBody = document.getElementById('mobileInventoryBody');
        if (mobileInventoryBody) {
            mobileInventoryBody.innerHTML = '';
        }

        // Tạo bảng cho từng sản phẩm
        products.forEach((product, index) => {
            // Lấy màu từ sản phẩm (product[6] là màu)
            const productColor = product[6] || '#4CAF50'; // Mặc định là màu xanh nếu không có
            
            // Xác định màu chữ phù hợp với nền
            const textColor = getContrastColor(productColor);
            
            // Xác định class NCC cho mobile
            let nccClass = '';
            if (product[1] === 'NPHP') nccClass = 'nphp';
            else if (product[1] === 'CỐT LÕI') nccClass = 'cotloi';
            else if (product[1] === 'KHÁC') nccClass = 'khac';

            // Tạo hàng cho desktop
            const row = document.createElement('tr');
            
            // Áp dụng màu trực tiếp cho hàng
            row.style.backgroundColor = productColor;
            row.style.color = textColor;

            // STT
            const sttCell = document.createElement('td');
            sttCell.textContent = index + 1;
            row.appendChild(sttCell);

            // NCC
            const nccCell = document.createElement('td');
            nccCell.textContent = product[1];
            row.appendChild(nccCell);

            // Tên hàng
            const nameCell = document.createElement('td');
            nameCell.textContent = product[2];
            row.appendChild(nameCell);

            // ĐVT
            const unitCell = document.createElement('td');
            unitCell.textContent = product[3];
            row.appendChild(unitCell);

            // Tồn đầu (ngày 1) - tính từ ngày cuối cùng của tháng trước
            const firstDayInventory = getStartOfMonthInventory(product[2]);
            const startInventoryCell = document.createElement('td');
            startInventoryCell.textContent = firstDayInventory !== null ? firstDayInventory : '';
            startInventoryCell.style.backgroundColor = '#f8f9fc'; // Màu nền khác biệt
            row.appendChild(startInventoryCell);

            // Các ngày trong tháng cho desktop
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('td');
                const inventory = getDayInventory(product[2], day);

                // Nếu là ngày hiện tại, thêm class để đánh dấu
                if (year == currentYearNum && month == currentMonthNum && day == currentDay) {
                    dayCell.style.backgroundColor = '#e3f2fd';
                }

                // Chỉ hiển thị giá trị nếu không phải null
                dayCell.textContent = inventory !== null ? inventory : '';
                row.appendChild(dayCell);
            }

            tbody.appendChild(row);

            // Tạo hàng cho mobile (kiểm tra xem phần tử có tồn tại không)
            if (mobileInventoryBody) {
                const mobileRow = document.createElement('div');
                mobileRow.className = `mobile-inventory-row ${nccClass}`;
                
                // Tên hàng
                const mobileNameCell = document.createElement('div');
                mobileNameCell.className = 'mobile-product-cell';
                mobileNameCell.textContent = product[2];
                mobileRow.appendChild(mobileNameCell);
                
                // Container cho các ngày
                const mobileDaysContainer = document.createElement('div');
                mobileDaysContainer.className = 'mobile-days-data';
                
                // Các ngày trong tháng cho mobile
                for (let day = 1; day <= daysInMonth; day++) {
                    const mobileDayCell = document.createElement('div');
                    mobileDayCell.className = 'mobile-day-cell';
                    
                    const inventory = getDayInventory(product[2], day);
                    
                    // Nếu là ngày hiện tại, thêm class để đánh dấu
                    if (year == currentYearNum && month == currentMonthNum && day == currentDay) {
                        mobileDayCell.classList.add('current-day');
                    }
                    
                    // Chỉ hiển thị giá trị nếu không phải null
                    mobileDayCell.textContent = inventory !== null ? inventory : '';
                    
                    mobileDaysContainer.appendChild(mobileDayCell);
                }
                
                mobileRow.appendChild(mobileDaysContainer);
                mobileInventoryBody.appendChild(mobileRow);
            }
        });

        // Đồng bộ hóa cuộn ngang giữa header và body
        syncMobileScroll();
        
        // Kích hoạt chế độ sửa trực tiếp sau khi tải xong bảng
        setupEditableInventoryTable();
    } catch (error) {
        console.error('Error loading inventory table:', error);
        showErrorToast('Lỗi khi tải bảng tồn kho');
    }
}

// Đồng bộ hóa cuộn ngang giữa header và body trên mobile
function syncMobileScroll() {
    const mobileDaysHeader = document.getElementById('mobileDaysHeader');
    const mobileInventoryBody = document.getElementById('mobileInventoryBody');
    
    if (!mobileDaysHeader || !mobileInventoryBody) return;
    
    // Lấy tất cả các container ngày trong body
    const mobileDaysDataElements = mobileInventoryBody.querySelectorAll('.mobile-days-data');
    
    // Đồng bộ cuộn từ header đến các container trong body
    mobileDaysHeader.addEventListener('scroll', function() {
        mobileDaysDataElements.forEach(element => {
            element.scrollLeft = this.scrollLeft;
        });
    });
    
    // Đồng bộ cuộn từ container đầu tiên trong body đến header
    if (mobileDaysDataElements.length > 0) {
        mobileDaysDataElements[0].addEventListener('scroll', function() {
            mobileDaysHeader.scrollLeft = this.scrollLeft;
            
            // Đồng bộ với các container khác
            for (let i = 1; i < mobileDaysDataElements.length; i++) {
                mobileDaysDataElements[i].scrollLeft = this.scrollLeft;
            }
        });
    }
}

// Hàm xác định màu chữ phù hợp với màu nền
function getContrastColor(hexColor) {
    // Chuyển đổi hex sang RGB
    const r = parseInt(hexColor.substr(1, 2), 16);
    const g = parseInt(hexColor.substr(3, 2), 16);
    const b = parseInt(hexColor.substr(5, 2), 16);
    
    // Tính độ sáng (luminance)
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Trả về màu đen hoặc trắng tùy thuộc vào độ sáng của nền
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

// Hàm lấy tồn đầu tháng (ngày cuối tháng trước)
function getStartOfMonthInventory(productName) {
    // Tính ngày cuối cùng của tháng trước
    const prevMonthLastDay = new Date(currentYear, currentMonth - 1, 0).getDate();
    const prevMonth = currentMonth - 1 === 0 ? 12 : currentMonth - 1;
    const prevYear = currentMonth - 1 === 0 ? currentYear - 1 : currentYear;
    
    const prevDateStr = `${String(prevMonthLastDay).padStart(2, '0')}/${String(prevMonth).padStart(2, '0')}/${prevYear}`;
    
    // Tìm tồn kho của ngày cuối tháng trước
    const inventory = inventoryData.find(item => 
        item[1] === prevDateStr && item[2] === productName
    );
    
    return inventory ? inventory[3] : 0;
}

// Hàm lấy tồn cho một ngày cụ thể trong tháng
function getDayInventory(productName, day) {
    const dateStr = `${String(day).padStart(2, '0')}/${String(currentMonth).padStart(2, '0')}/${currentYear}`;
    const inventory = inventoryData.find(item => 
        item[1] === dateStr && item[2] === productName
    );
    
    return inventory ? inventory[3] : 0;
}

// Hiển thị form nhập tồn kho
function showInventoryForm() {
    const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
    modal.show();

    // Cập nhật thông tin sản phẩm
    updateProductInfo();
}

// Cập nhật thông tin sản phẩm hiện tại
async function updateProductInfo() {
    if (products.length === 0) return;

    const product = products[currentProductIndex];
    document.getElementById('productName').value = product[2];
    document.getElementById('unit').value = product[3];

    try {
        // Lấy tồn trước (ngày hôm qua)
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = formatDate(yesterday);

        // Lấy tồn kho ngày hôm qua từ server
        const yesterdayResponse = await fetch(`${API_BASE_URL}/inventory?date=${yesterdayStr}`);
        if (!yesterdayResponse.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho ngày hôm qua');
        }
        const yesterdayInventoryData = await yesterdayResponse.json();
        
        const yesterdayInventory = yesterdayInventoryData.find(item => item[2] === product[2]);
        document.getElementById('previousInventory').value = yesterdayInventory ? yesterdayInventory[3] : 0; // Hiển thị 0 thay vì chuỗi rỗng

        // Lấy tồn hôm nay (nếu có)
        const todayStr = formatDate(today);
        const todayResponse = await fetch(`${API_BASE_URL}/inventory?date=${todayStr}`);
        if (!todayResponse.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho ngày hôm nay');
        }
        const todayInventoryData = await todayResponse.json();
        
        const todayInventory = todayInventoryData.find(item => item[2] === product[2]);
        document.getElementById('todayInventory').value = todayInventory ? todayInventory[3] : ""; // Để trống để người dùng nhập
    } catch (error) {
        console.error('Error updating product info:', error);
        document.getElementById('previousInventory').value = 0; // Hiển thị 0 thay vì chuỗi rỗng
        document.getElementById('todayInventory').value = "";
    }
}

// Định dạng ngày thành dd/mm/yyyy
function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Chuyển đến sản phẩm tiếp theo
function nextProduct() {
    if (currentProductIndex < products.length - 1) {
        currentProductIndex++;
        updateProductInfo();
    }
}

// Chuyển đến sản phẩm trước đó
function previousProduct() {
    if (currentProductIndex > 0) {
        currentProductIndex--;
        updateProductInfo();
    }
}

// Lưu và tiếp tục
async function saveAndContinue() {
    const productName = document.getElementById('productName').value;
    const todayInventory = document.getElementById('todayInventory').value;

    if (!productName || !todayInventory) {
        showErrorToast('Vui lòng nhập đầy đủ thông tin');
        return;
    }

    const today = formatDate(new Date());

    try {
        // Tìm ID sản phẩm từ tên
        const product = products.find(p => p[2] === productName);
        if (!product) {
            showErrorToast('Không tìm thấy sản phẩm');
            return;
        }

        // Hiển thị loading
        showLoading();

        // Gửi dữ liệu lên server
        const response = await fetch(`${API_BASE_URL}/inventory`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ngay: today,
                id_san_pham: product[0], // ID sản phẩm
                so_luong: parseInt(todayInventory)
            })
        });

        if (response.ok) {
            // Cập nhật lại dữ liệu tồn kho trong biến inventoryData
            inventoryData.push([0, today, productName, parseInt(todayInventory)]);
            
            // Cập nhật lại bảng tồn kho
            await loadInventoryTable();
            
            // Hiển thị thông báo thành công
            showSuccessToast('Lưu tồn kho thành công!');
            
            // Chuyển đến sản phẩm tiếp theo
            if (currentProductIndex < products.length - 1) {
                currentProductIndex++;
                updateProductInfo();
            } else {
                // Đã đến sản phẩm cuối cùng
                const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryModal'));
                modal.hide();
            }
        } else {
            showErrorToast('Lỗi khi lưu dữ liệu');
        }
    } catch (error) {
        console.error('Error saving inventory:', error);
        showErrorToast('Lỗi khi lưu dữ liệu');
    } finally {
        // Ẩn loading
        hideLoading();
    }
}

// Xuất Excel tồn kho
function exportInventoryToExcel() {
    const monthYear = document.getElementById('inventoryMonth').value;
    if (!monthYear) {
        alert('Vui lòng chọn tháng/năm');
        return;
    }

    const fileName = `TonKho_${monthYear}.xlsx`;

    // Tạo dữ liệu cho Excel
    const table = document.getElementById('inventoryTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Tồn Kho"});

    // Xuất file
    XLSX.writeFile(wb, fileName);
}

// Thiết lập bảng nhập hàng
function setupImportTable() {
    const tbody = document.querySelector('#importTable tbody');
    tbody.innerHTML = '';

    // Lấy ngày hiện tại
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('importDate').value = formattedDate;

    // Tạo 10 dòng mặc định
    for (let i = 1; i <= 10; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${i}</td>
            <td>
                <input type="text" class="form-control product-suggest" placeholder="Tên hàng">
            </td>
            <td>
                <input type="number" class="form-control" placeholder="Số lượng">
            </td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="removeImportRow(this)">Xóa</button>
            </td>
        `;
        tbody.appendChild(row);
    }

    // Thiết lập autocomplete cho tên hàng
    setupProductAutocomplete();
}

// Thiết lập autocomplete cho tên hàng
function setupProductAutocomplete() {
    const inputs = document.querySelectorAll('.product-suggest');
    
    inputs.forEach(input => {
        // Tạo dropdown cho gợi ý
        const dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';
        dropdown.style.position = 'absolute';
        dropdown.style.width = '200px';
        dropdown.style.maxHeight = '200px';
        dropdown.style.overflowY = 'auto';
        dropdown.style.backgroundColor = 'white';
        dropdown.style.border = '1px solid #ddd';
        dropdown.style.zIndex = '1000';
        dropdown.style.display = 'none';
        dropdown.style.borderRadius = '4px';
        dropdown.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        
        // Thêm dropdown vào body
        document.body.appendChild(dropdown);
        
        input.addEventListener('input', function() {
            const value = this.value.toLowerCase();
            dropdown.innerHTML = '';
            
            if (value.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            
            const suggestions = products.filter(product => 
                product[2].toLowerCase().includes(value)
            );
            
            if (suggestions.length > 0) {
                suggestions.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.style.padding = '8px 12px';
                    item.style.cursor = 'pointer';
                    
                    // Highlight phần khớp với từ khóa
                    const regex = new RegExp(`(${value})`, 'gi');
                    item.innerHTML = product[2].replace(regex, '<strong>$1</strong>');
                    
                    item.addEventListener('click', function() {
                        input.value = product[2];
                        dropdown.style.display = 'none';
                    });
                    
                    // Thêm hiệu ứng hover
                    item.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f0f0f0';
                    });
                    
                    item.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    dropdown.appendChild(item);
                });
                
                // Định vị dropdown
                const rect = input.getBoundingClientRect();
                dropdown.style.left = rect.left + 'px';
                dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        });
        
        // Ẩn dropdown khi click bên ngoài
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Ẩn dropdown khi nhấn Escape
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        });
    });
}

// Thêm dòng nhập hàng
function addImportRow() {
    const tbody = document.querySelector('#importTable tbody');
    const rowCount = tbody.rows.length;

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${rowCount + 1}</td>
        <td>
            <input type="text" class="form-control product-suggest" placeholder="Tên hàng">
        </td>
        <td>
            <input type="number" class="form-control" placeholder="Số lượng">
        </td>
        <td>
            <button class="btn btn-danger btn-sm" onclick="removeImportRow(this)">Xóa</button>
        </td>
    `;
    tbody.appendChild(row);

    // Thiết lập autocomplete cho dòng mới
    setupProductAutocomplete();
}

// Xóa dòng nhập hàng
function removeImportRow(button) {
    const row = button.closest('tr');
    row.remove();

    // Cập nhật lại STT
    const rows = document.querySelectorAll('#importTable tbody tr');
    rows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
    });
}

// Lưu nhập hàng
async function saveImport() {
    const date = document.getElementById('importDate').value;
    const rows = document.querySelectorAll('#importTable tbody tr');
    const importList = [];

    rows.forEach(row => {
        const productName = row.querySelector('.product-suggest').value;
        const quantity = row.querySelector('input[type="number"]').value;

        if (productName && quantity) {
            // Tìm ID sản phẩm từ tên
            const product = products.find(p => p[2] === productName);
            if (product) {
                importList.push({
                    ngay: date,
                    id_san_pham: product[0], // ID sản phẩm
                    so_luong: parseInt(quantity)
                });
            }
        }
    });

    if (importList.length === 0) {
        showErrorToast('Vui lòng nhập ít nhất một mặt hàng');
        return;
    }

    try {
        // Gửi từng mục nhập hàng lên server
        for (const item of importList) {
            const response = await fetch(`${API_BASE_URL}/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item)
            });

            if (!response.ok) {
                throw new Error('Lỗi khi lưu dữ liệu');
            }
        }

        showSuccessToast('Lưu nhập hàng thành công!');
        setupImportTable(); // Reset bảng
    } catch (error) {
        console.error('Error saving import:', error);
        showErrorToast('Lỗi khi lưu dữ liệu nhập hàng');
    }
}

// Hiển thị danh sách nhập hàng
async function showImportList() {
    const modal = new bootstrap.Modal(document.getElementById('importListModal'));
    modal.show();

    // Load danh sách nhập hàng
    await loadImportList();
}

// Load danh sách nhập hàng
async function loadImportList(dateFilter = '') {
    try {
        let url = `${API_BASE_URL}/import`;
        if (dateFilter) {
            url += `?date=${dateFilter}`;
        }

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Lỗi khi tải danh sách nhập hàng');
        }
        const imports = await response.json();

        // Hiển thị danh sách
        const tbody = document.querySelector('#importListTable tbody');
        tbody.innerHTML = '';

        imports.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item[2]}</td>
                <td>${item[1]}</td>
                <td>${item[3]}</td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading import list:', error);
        alert('Lỗi khi tải danh sách nhập hàng');
    }
}

// Lọc danh sách nhập hàng theo ngày
function filterImportList() {
    const dateFilter = document.getElementById('filterImportDate').value;
    if (dateFilter) {
        // Chuyển định dạng từ yyyy-mm-dd sang dd/mm/yyyy
        const [year, month, day] = dateFilter.split('-');
        const formattedDate = `${day}/${month}/${year}`;
        loadImportList(formattedDate);
    } else {
        loadImportList();
    }
}

// Xuất Excel danh sách nhập hàng
function exportImportToExcel() {
    const dateFilter = document.getElementById('filterImportDate').value;
    let fileName = 'DanhSachNhapHang';

    if (dateFilter) {
        fileName += `_${dateFilter}`;
    }

    fileName += '.xlsx';

    // Tạo dữ liệu cho Excel
    const table = document.getElementById('importListTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Danh Sách Nhập Hàng"});

    // Xuất file
    XLSX.writeFile(wb, fileName);
}

// Load bảng sử dụng
async function loadUsageTable() {
    const usageDate = document.getElementById('usageDate').value;
    if (!usageDate) return;
    
    // Chuyển định dạng từ YYYY-MM-DD sang DD/MM/YYYY
    const [year, month, day] = usageDate.split('-');
    const dateStr = `${day}/${month}/${year}`;
    
    // Tính ngày trước đó
    const prevDate = new Date(year, month - 1, day);
    prevDate.setDate(prevDate.getDate() - 1);
    const prevDateStr = formatDate(prevDate);
    
    try {
        // Lấy dữ liệu tồn kho cho ngày hiện tại và ngày trước
        const [currentInventoryResponse, prevInventoryResponse] = await Promise.all([
            fetch(`${API_BASE_URL}/inventory?date=${dateStr}`),
            fetch(`${API_BASE_URL}/inventory?date=${prevDateStr}`)
        ]);
        
        if (!currentInventoryResponse.ok || !prevInventoryResponse.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho');
        }
        
        const currentInventoryData = await currentInventoryResponse.json();
        const prevInventoryData = await prevInventoryResponse.json();
        
        // Thử lấy dữ liệu nhập hàng với endpoint /import
        let importData = [];
        try {
            // Thử với endpoint /import (không có 's')
            const importResponse = await fetch(`${API_BASE_URL}/import?date=${dateStr}`);
            
            if (importResponse.ok) {
                importData = await importResponse.json();
                console.log("Import data loaded:", importData);
            } else {
                // Nếu không thành công, tính toán từ bảng tồn kho
                importData = await calculateImportData(dateStr, prevDateStr);
                console.log("Import data calculated:", importData);
            }
        } catch (importError) {
            console.warn('Không thể tải dữ liệu nhập hàng, tính toán từ bảng tồn kho:', importError);
            importData = await calculateImportData(dateStr, prevDateStr);
            console.log("Import data calculated:", importData);
        }
        
        // Tạo bảng
        const tbody = document.querySelector('#usageTable tbody');
        tbody.innerHTML = '';
        
        // Lặp qua tất cả sản phẩm
        products.forEach((product, index) => {
            const row = document.createElement('tr');
            
            // STT
            const sttCell = document.createElement('td');
            sttCell.textContent = index + 1;
            row.appendChild(sttCell);
            
            // NCC
            const nccCell = document.createElement('td');
            nccCell.textContent = product[1];
            row.appendChild(nccCell);
            
            // Tên hàng
            const nameCell = document.createElement('td');
            nameCell.textContent = product[2];
            row.appendChild(nameCell);
            
            // Tồn Trước (ngày trước đó)
            const prevInventoryItem = prevInventoryData.find(item => item[2] === product[2]);
            const prevInventory = prevInventoryItem ? prevInventoryItem[3] : 0;
            const prevInventoryCell = document.createElement('td');
            prevInventoryCell.textContent = prevInventory;
            row.appendChild(prevInventoryCell);
            
            // Tồn Cuối (ngày hiện tại)
            const currentInventoryItem = currentInventoryData.find(item => item[2] === product[2]);
            const currentInventory = currentInventoryItem ? currentInventoryItem[3] : 0;
            const currentInventoryCell = document.createElement('td');
            currentInventoryCell.textContent = currentInventory;
            row.appendChild(currentInventoryCell);
            
            // Nhập (ngày hiện tại) - Thử nhiều cách tìm kiếm
            let importQuantity = 0;
            
            // Cách 1: Tìm theo tên sản phẩm trực tiếp
            const importItem = importData.find(item => item[2] === product[2]);
            if (importItem) {
                importQuantity = importItem[3] || 0;
            } else {
                // Cách 2: Tìm theo ID sản phẩm
                const importItemById = importData.find(item => {
                    // Kiểm tra xem có trường id_san_pham không
                    if (item.id_san_pham !== undefined) {
                        return item.id_san_pham == product[0];
                    }
                    return false;
                });
                
                if (importItemById) {
                    importQuantity = importItemById.so_luong || importItemById[3] || 0;
                } else {
                    // Cách 3: Tìm theo ten_hang (nếu có)
                    const importItemByName = importData.find(item => {
                        if (item.ten_hang !== undefined) {
                            return item.ten_hang === product[2];
                        }
                        return false;
                    });
                    
                    if (importItemByName) {
                        importQuantity = importItemByName.so_luong || 0;
                    } else {
                        console.log(`Không tìm thấy dữ liệu nhập hàng cho sản phẩm ${product[2]} (ID: ${product[0]})`);
                    }
                }
            }
            
            const importCell = document.createElement('td');
            importCell.textContent = importQuantity;
            row.appendChild(importCell);
            
            // Sử dụng = Tồn Trước - Tồn Cuối + Nhập
            const usage = prevInventory - currentInventory + importQuantity;
            const usageCell = document.createElement('td');
            usageCell.textContent = usage;
            row.appendChild(usageCell);
            
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading usage table:', error);
        showErrorToast('Lỗi khi tải bảng sử dụng');
    }
}
// Tính toán dữ liệu nhập hàng dựa trên sự thay đổi tồn kho
async function calculateImportData(dateStr, prevDateStr) {
    try {
        // Lấy dữ liệu tồn kho cho ngày được chọn và ngày trước đó
        const [currentInventoryResponse, prevInventoryResponse] = await Promise.all([
            fetch(`${API_BASE_URL}/inventory?date=${dateStr}`),
            fetch(`${API_BASE_URL}/inventory?date=${prevDateStr}`)
        ]);
        
        if (!currentInventoryResponse.ok || !prevInventoryResponse.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho');
        }
        
        const currentInventoryData = await currentInventoryResponse.json();
        const prevInventoryData = await prevInventoryResponse.json();
        
        // Tính toán dữ liệu nhập hàng
        const importData = [];
        
        for (const product of products) {
            const productName = product[2];
            const productId = product[0];
            
            // Lấy tồn kho ngày hiện tại và ngày trước
            const currentInventory = currentInventoryData.find(item => item[2] === productName);
            const prevInventory = prevInventoryData.find(item => item[2] === productName);
            
            const currentQuantity = currentInventory ? parseInt(currentInventory[3]) : 0;
            const prevQuantity = prevInventory ? parseInt(prevInventory[3]) : 0;
            
            // Tính toán lượng nhập hàng
            // Nếu tồn kho tăng, giả định có nhập hàng
            const inventoryChange = currentQuantity - prevQuantity;
            let importQuantity = 0;
            
            if (inventoryChange > 0) {
                importQuantity = inventoryChange;
            }
            
            if (importQuantity > 0) {
                // Thêm vào dữ liệu nhập hàng với cấu trúc phù hợp
                importData.push({
                    0: importData.length + 1, // ID
                    1: dateStr, // Ngày nhập
                    2: productName, // Tên hàng
                    3: importQuantity // Số lượng
                });
                
                // Thêm cả định dạng có id_san_pham để đảm bảo tương thích
                importData.push({
                    id: importData.length,
                    ngay: dateStr,
                    id_san_pham: productId,
                    ten_hang: productName,
                    so_luong: importQuantity
                });
            }
        }
        
        return importData;
    } catch (error) {
        console.error('Error calculating import data:', error);
        return [];
    }
}

// Chuyển đổi loại báo cáo
function toggleReportType() {
    const dailyReport = document.getElementById('dailyReport').checked;
    const dailyReportDiv = document.getElementById('dailyReportDiv');
    const monthlyReportDiv = document.getElementById('monthlyReportDiv');

    if (dailyReport) {
        dailyReportDiv.style.display = 'block';
        monthlyReportDiv.style.display = 'none';
    } else {
        dailyReportDiv.style.display = 'none';
        monthlyReportDiv.style.display = 'block';
    }

    // Tải lại bảng báo cáo
    loadReportTable();
}

// Load bảng báo cáo
async function loadReportTable() {
    const dailyReport = document.getElementById('dailyReport').checked;
    let date, month, year;

    try {
        // Hiển thị loading
        showLoading();

        if (dailyReport) {
            date = document.getElementById('reportDate').value;
            if (!date) {
                // Nếu chưa chọn ngày, sử dụng ngày hiện tại
                const today = new Date();
                date = today.toISOString().split('T')[0];
                document.getElementById('reportDate').value = date;
            }

            const response = await fetch(`${API_BASE_URL}/report?type=daily&date=${date}`);
            if (!response.ok) {
                throw new Error('Lỗi khi tải báo cáo theo ngày');
            }
            const reportData = await response.json();

            // Hiển thị bảng
            const tbody = document.querySelector('#reportTable tbody');
            tbody.innerHTML = '';

            let totalAmount = 0;

            reportData.forEach((item, index) => {
                const row = document.createElement('tr');

                // STT
                const sttCell = document.createElement('td');
                sttCell.textContent = index + 1;
                row.appendChild(sttCell);

                // NCC
                const nccCell = document.createElement('td');
                nccCell.textContent = item.ncc;
                row.appendChild(nccCell);

                // Tên hàng
                const nameCell = document.createElement('td');
                nameCell.textContent = item.tenHang;
                row.appendChild(nameCell);

                // ĐVT
                const unitCell = document.createElement('td');
                unitCell.textContent = item.dvt;
                row.appendChild(unitCell);

                // Tồn trước
                const beforeCell = document.createElement('td');
                beforeCell.textContent = item.tonTruoc;
                row.appendChild(beforeCell);

                // Tồn sau
                const afterCell = document.createElement('td');
                afterCell.textContent = item.tonSau;
                row.appendChild(afterCell);

                // Nhập
                const importCell = document.createElement('td');
                importCell.textContent = item.nhap;
                row.appendChild(importCell);

                // Sử dụng
                const usageCell = document.createElement('td');
                usageCell.textContent = item.suDung;
                row.appendChild(usageCell);

                // Thành tiền - đảm bảo tính toán chính xác
                const thanhTien = parseFloat(item.thanhTien) || 0;
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCurrency(thanhTien);
                row.appendChild(amountCell);

                totalAmount += thanhTien;

                tbody.appendChild(row);
            });

            // Cập nhật tổng tiền
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        } else {
            // Báo cáo theo tháng
            const monthYear = document.getElementById('reportMonth').value;
            if (!monthYear) {
                // Nếu chưa chọn tháng, sử dụng tháng hiện tại
                const now = new Date();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const currentMonthYear = `${year}-${month}`;
                document.getElementById('reportMonth').value = currentMonthYear;
                monthYear = currentMonthYear;
            }

            const response = await fetch(`${API_BASE_URL}/report?type=monthly&date=${monthYear}`);
            if (!response.ok) {
                throw new Error('Lỗi khi tải báo cáo theo tháng');
            }
            const reportData = await response.json();

            // Hiển thị bảng
            const tbody = document.querySelector('#reportTable tbody');
            tbody.innerHTML = '';

            let totalAmount = 0;

            reportData.forEach((item, index) => {
                const row = document.createElement('tr');

                // STT
                const sttCell = document.createElement('td');
                sttCell.textContent = index + 1;
                row.appendChild(sttCell);

                // NCC
                const nccCell = document.createElement('td');
                nccCell.textContent = item.ncc;
                row.appendChild(nccCell);

                // Tên hàng
                const nameCell = document.createElement('td');
                nameCell.textContent = item.tenHang;
                row.appendChild(nameCell);

                // ĐVT
                const unitCell = document.createElement('td');
                unitCell.textContent = item.dvt;
                row.appendChild(unitCell);

                // Tồn đầu tháng
                const startInventoryCell = document.createElement('td');
                startInventoryCell.textContent = item.tonDauThang;
                row.appendChild(startInventoryCell);

                // Tồn cuối tháng
                const endInventoryCell = document.createElement('td');
                endInventoryCell.textContent = item.tonCuoiThang;
                row.appendChild(endInventoryCell);

                // Nhập trong tháng
                const importCell = document.createElement('td');
                importCell.textContent = item.nhapTrongThang;
                row.appendChild(importCell);

                // Sử dụng trong tháng
                const usageCell = document.createElement('td');
                usageCell.textContent = item.suDungTrongThang;
                row.appendChild(usageCell);

                // Thành tiền - đảm bảo tính toán chính xác
                const thanhTien = parseFloat(item.thanhTien) || 0;
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCurrency(thanhTien);
                row.appendChild(amountCell);

                totalAmount += thanhTien;

                tbody.appendChild(row);
            });

            // Cập nhật tổng tiền
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }
        
        // Ẩn loading
        hideLoading();
    } catch (error) {
        console.error('Error loading report table:', error);
        showErrorToast('Lỗi khi tải bảng báo cáo');
        hideLoading();
    }
}

// Hàm định dạng tiền tệ
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { 
        style: 'currency', 
        currency: 'VND',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Xuất Excel báo cáo
function exportReportToExcel() {
    const dailyReport = document.getElementById('dailyReport').checked;
    let fileName;
    
    if (dailyReport) {
        const date = document.getElementById('reportDate').value;
        fileName = `BaoCaoTheoNgay_${date}.xlsx`;
    } else {
        const monthYear = document.getElementById('reportMonth').value;
        fileName = `BaoCaoTheoThang_${monthYear}.xlsx`;
    }
    
    // Tạo dữ liệu cho Excel
    const table = document.getElementById('reportTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Báo Cáo"});
    
    // Xuất file
    XLSX.writeFile(wb, fileName);
}

// Load bảng sản phẩm
async function loadProductTable() {
    try {
        const response = await fetch(`${API_BASE_URL}/products`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải danh sách sản phẩm');
        }
        products = await response.json();
        
        const tbody = document.querySelector('#productTable tbody');
        tbody.innerHTML = '';
        
        products.forEach((product, index) => {
            const row = document.createElement('tr');
            
            // STT
            const sttCell = document.createElement('td');
            sttCell.textContent = index + 1;
            row.appendChild(sttCell);
            
            // NCC
            const nccCell = document.createElement('td');
            nccCell.textContent = product[1];
            row.appendChild(nccCell);
            
            // Tên hàng
            const nameCell = document.createElement('td');
            nameCell.textContent = product[2];
            row.appendChild(nameCell);
            
            // ĐVT
            const unitCell = document.createElement('td');
            unitCell.textContent = product[3];
            row.appendChild(unitCell);
            
            // Tồn tối thiểu
            const minInventoryCell = document.createElement('td');
            minInventoryCell.textContent = product[4];
            row.appendChild(minInventoryCell);
            
            // Giá
            const priceCell = document.createElement('td');
            priceCell.textContent = parseFloat(product[5]).toLocaleString('vi-VN');
            row.appendChild(priceCell);
            
            // Màu NCC
            const colorCell = document.createElement('td');
            const colorBox = document.createElement('div');
            colorBox.style.width = '20px';
            colorBox.style.height = '20px';
            colorBox.style.backgroundColor = product[6];
            colorBox.style.display = 'inline-block';
            colorBox.style.border = '1px solid #ccc';
            colorCell.appendChild(colorBox);
            row.appendChild(colorCell);
            
            // Nút hành động
            const actionCell = document.createElement('td');
            actionCell.innerHTML = `
                <button class="btn btn-sm btn-primary" onclick="editProduct(${product[0]})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product[0]})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            row.appendChild(actionCell);
            
            tbody.appendChild(row);
        });
        
        // Thiết lập kéo thả sau khi đã tải xong bảng
        setupProductDragAndDrop();
    } catch (error) {
        console.error('Error loading product table:', error);
        alert('Lỗi khi tải bảng sản phẩm');
    }
}

// Hiển thị form thêm sản phẩm
function showAddProductForm() {
    if (!requireAdmin()) return;
    
    document.getElementById('productId').value = '';
    document.getElementById('productNcc').value = 'NPHP';
    document.getElementById('productTenHang').value = '';
    document.getElementById('productDvt').value = '';
    document.getElementById('productTonToiThieu').value = '';
    document.getElementById('productGia').value = '';
    document.getElementById('productMauNcc').value = '#4CAF50';
    
    document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-box me-2"></i>Thêm Hàng Hóa';
    
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

// Sửa sản phẩm
function editProduct(id) {
    if (!requireAdmin()) return;
    
    const product = products.find(p => p[0] == id);
    if (!product) {
        alert('Không tìm thấy sản phẩm');
        return;
    }
    
    document.getElementById('productId').value = product[0];
    document.getElementById('productNcc').value = product[1];
    document.getElementById('productTenHang').value = product[2];
    document.getElementById('productDvt').value = product[3];
    document.getElementById('productTonToiThieu').value = product[4];
    document.getElementById('productGia').value = product[5];
    document.getElementById('productMauNcc').value = product[6];
    
    document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-box me-2"></i>Sửa Hàng Hóa';
    
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

// Lưu sản phẩm
async function saveProduct() {
    const productId = document.getElementById('productId').value;
    const ncc = document.getElementById('productNcc').value;
    const tenHang = document.getElementById('productTenHang').value;
    const dvt = document.getElementById('productDvt').value;
    const tonToiThieu = document.getElementById('productTonToiThieu').value;
    const gia = document.getElementById('productGia').value;
    const mauNcc = document.getElementById('productMauNcc').value;

    if (!ncc || !tenHang || !dvt) {
        showErrorToast('Vui lòng nhập đầy đủ thông tin');
        return;
    }

    try {
        showLoading();

        const productData = {
            ncc: ncc,
            ten_hang: tenHang,
            dvt: dvt,
            ton_toi_thieu: tonToiThieu ? parseInt(tonToiThieu) : 0,
            gia: gia ? parseInt(gia) : 0,
            mau_ncc: mauNcc
        };

        let response;
        if (productId) {
            // Cập nhật sản phẩm
            response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            });
        } else {
            // Thêm mới sản phẩm
            response = await fetch(`${API_BASE_URL}/products`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            });
        }

        if (response.ok) {
            showSuccessToast(productId ? 'Cập nhật sản phẩm thành công!' : 'Thêm sản phẩm thành công!');
            
            // Đóng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();
            
            // Tải lại danh sách sản phẩm
            await loadProducts();
            
            // Tải lại bảng sản phẩm
            loadProductTable();
            
            // Tải lại bảng tồn kho (nếu đang ở tab tồn kho)
            const inventoryTab = document.getElementById('inventory-tab');
            if (inventoryTab.classList.contains('active')) {
                await loadInventoryTable();
            }
        } else {
            showErrorToast('Lỗi khi lưu sản phẩm');
        }
    } catch (error) {
        console.error('Error saving product:', error);
        showErrorToast('Lỗi khi lưu sản phẩm');
    } finally {
        hideLoading();
    }
}

async function deleteProduct(id) {
    if (!requireAdmin()) return;
    
    if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/products/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadProducts().then(() => {
                loadProductTable();
            });
            
            // Hiển thị thông báo thành công
            showSuccessToast('Xóa sản phẩm thành công!');
        } else {
            showErrorToast('Lỗi khi xóa sản phẩm');
        }
    } catch (error) {
        console.error('Error deleting product:', error);
        showErrorToast('Lỗi khi xóa sản phẩm');
    }
}

// Tạo danh sách lên hàng
async function generateRestockList() {
    if (!requireAdmin()) return;
    
    try {
        // Xóa danh sách hiện tại
        restockList = [];
        
        // Lấy ngày đã chọn
        const restockDate = document.getElementById('restockDate').value;
        if (!restockDate) {
            showErrorToast('Vui lòng chọn ngày');
            return;
        }
        
        // Chuyển định dạng từ YYYY-MM-DD sang DD/MM/YYYY
        const [year, month, day] = restockDate.split('-');
        const dateStr = `${day}/${month}/${year}`;

        const tbody = document.querySelector('#restockTable tbody');
        tbody.innerHTML = '';
        
        // Hiển thị loading
        showLoading();
        
        const response = await fetch(`${API_BASE_URL}/inventory?date=${dateStr}`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho');
        }
        const inventoryData = await response.json();
        
        // Tạo danh sách lên hàng dựa trên tồn kho tối thiểu
        products.forEach(product => {
            // Tìm tồn kho hiện tại của sản phẩm
            const inventory = inventoryData.find(item => item[2] === product[2]);
            const currentInventory = inventory ? parseInt(inventory[3]) : 0;
            
            // Kiểm tra nếu tồn kho hiện tại nhỏ hơn tồn tối thiểu
            if (currentInventory < product[4]) {
                const canDat = product[4] - currentInventory;
                restockList.push({
                    id: product[0],
                    ncc: product[1],
                    tenHang: product[2],
                    tonHienTai: currentInventory,
                    tonToiThieu: product[4],
                    gia: product[5],
                    canDat: canDat,
                    thanhTien: product[5] * canDat
                });
            }
        });
        
        // Cập nhật bảng
        updateRestockTable();
        
        if (restockList.length === 0) {
            showInfoToast('Không có sản phẩm nào cần lên hàng cho ngày đã chọn');
        }
    } catch (error) {
        console.error('Error generating restock list:', error);
        showErrorToast('Lỗi khi tạo danh sách lên hàng');
    } finally {
        hideLoading();
    }
}

// Hàm hiển thị thông báo thông tin
function showInfoToast(message) {
    // Tạo một toast thông báo thông tin
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-info border-0';
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Thêm toast vào container
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    // Hiển thị toast
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // Xóa toast container sau khi toast bị ẩn
    toast.addEventListener('hidden.bs.toast', function () {
        document.body.removeChild(toastContainer);
    });
}

function setupEditableRestockTable() {
    const table = document.getElementById('restockTable');
    const cells = table.querySelectorAll('tbody td.editable-cell');
    
    cells.forEach(cell => {
        cell.addEventListener('click', function() {
            if (this.classList.contains('editing')) return;
            
            this.classList.add('editing');
            const currentValue = this.textContent;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.width = '100%';
            input.style.border = '1px solid var(--primary-color)';
            input.style.textAlign = 'center';
            input.style.padding = '5px';
            
            this.textContent = '';
            this.appendChild(input);
            input.focus();
            
            const saveCell = () => {
                const newValue = parseInt(input.value) || 0;
                this.classList.remove('editing');
                this.textContent = newValue;
                
                // Cập nhật thành tiền
                const row = this.parentNode;
                const priceCell = row.cells[5]; // Giá ở cột 6
                const price = parseFloat(priceCell.textContent.replace(/[^\d]/g, '')) || 0;
                const total = newValue * price;
                const totalCell = row.cells[7]; // Thành tiền ở cột 8
                totalCell.textContent = formatCurrency(total);
                
                // Cập nhật tổng tiền
                updateRestockTotal();
                
                // Cập nhật dữ liệu trong restockList
                const rowIndex = Array.from(row.parentNode.children).indexOf(row);
                if (restockList[rowIndex]) {
                    restockList[rowIndex].canDat = newValue;
                    restockList[rowIndex].thanhTien = total;
                }
            };
            
            input.addEventListener('blur', saveCell);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveCell();
                }
            });
        });
    });
}

// Cập nhật bảng lên hàng
function updateRestockTable() {
    const tbody = document.querySelector('#restockTable tbody');
    tbody.innerHTML = '';
    
    let totalAmount = 0;
    
    restockList.forEach((item, index) => {
        const row = document.createElement('tr');
        
        // STT
        const sttCell = document.createElement('td');
        sttCell.textContent = index + 1;
        row.appendChild(sttCell);
        
        // NCC
        const nccCell = document.createElement('td');
        nccCell.textContent = item.ncc;
        row.appendChild(nccCell);
        
        // Tên hàng
        const nameCell = document.createElement('td');
        nameCell.textContent = item.tenHang;
        row.appendChild(nameCell);
        
        // Tồn hiện tại
        const currentInventoryCell = document.createElement('td');
        currentInventoryCell.textContent = item.tonHienTai;
        row.appendChild(currentInventoryCell);
        
        // Tồn tối thiểu
        const minInventoryCell = document.createElement('td');
        minInventoryCell.textContent = item.tonToiThieu;
        row.appendChild(minInventoryCell);
        
        // Giá
        const priceCell = document.createElement('td');
        priceCell.textContent = formatCurrency(item.gia);
        row.appendChild(priceCell);
        
        // Cần đặt - THÊM CLASS EDITABLE-CELL
        const quantityCell = document.createElement('td');
        quantityCell.textContent = item.canDat;
        quantityCell.classList.add('editable-cell'); // Thêm class để có thể chỉnh sửa
        row.appendChild(quantityCell);
        
        // Thành tiền
        const amountCell = document.createElement('td');
        amountCell.textContent = formatCurrency(item.thanhTien);
        row.appendChild(amountCell);
        
        // Nút xóa
        const actionCell = document.createElement('td');
        actionCell.innerHTML = `
            <button class="btn btn-sm btn-danger" onclick="removeRestockItem(${index})">
                <i class="bi bi-trash"></i>
            </button>
        `;
        row.appendChild(actionCell);
        
        totalAmount += item.thanhTien;
        
        tbody.appendChild(row);
    });
    
    // Cập nhật tổng tiền
    document.getElementById('restockTotalAmount').textContent = formatCurrency(totalAmount);
    
    // Kích hoạt chức năng chỉnh sửa trực tiếp
    setupEditableRestockTable();
}

// Hàm định dạng tiền tệ
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        minimumFractionDigits: 0
    }).format(amount);
}

// Hàm cập nhật tổng tiền
function updateRestockTotal() {
    const table = document.getElementById('restockTable');
    const totalCell = document.getElementById('restockTotalAmount');
    let total = 0;
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const quantityCell = row.cells[6]; // Cần đặt ở cột 7
        const priceCell = row.cells[5]; // Giá ở cột 6
        const quantity = parseInt(quantityCell.textContent) || 0;
        const price = parseFloat(priceCell.textContent.replace(/[^\d]/g, '')) || 0;
        total += quantity * price;
    });
    
    totalCell.textContent = formatCurrency(total);
}

// Thêm hàng vào danh sách lên hàng
function addRestockItem() {
    if (!requireAdmin()) return;
    
    const modal = new bootstrap.Modal(document.getElementById('addRestockModal'));
    modal.show();
    
    // Lấy ngày đã chọn và hiển thị trong modal
    const restockDate = document.getElementById('restockDate').value;
    if (restockDate) {
        const [year, month, day] = restockDate.split('-');
        const dateStr = `${day}/${month}/${year}`;
        
        // Thêm thông tin ngày vào modal
        const modalBody = document.querySelector('#addRestockModal .modal-body');
        const dateInfo = document.createElement('div');
        dateInfo.className = 'alert alert-info';
        dateInfo.innerHTML = `<i class="bi bi-info-circle me-2"></i>Đang sử dụng dữ liệu tồn kho ngày: ${dateStr}`;
        
        // Chèn vào đầu modal body
        modalBody.insertBefore(dateInfo, modalBody.firstChild);
        
        // Xóa thông tin ngày khi đóng modal
        modal._element.addEventListener('hidden.bs.modal', function() {
            if (dateInfo.parentNode) {
                dateInfo.parentNode.removeChild(dateInfo);
            }
        });
    }
}

// Lưu và thêm hàng vào danh sách lên hàng
async function saveAndAddRestockItem() {
    const productId = document.getElementById('restockProductId').value;
    const quantity = document.getElementById('restockQuantity').value;
    
    if (!productId || !quantity) {
        showErrorToast('Vui lòng nhập đầy đủ thông tin');
        return;
    }
    
    try {
        // Lấy ngày đã chọn
        const restockDate = document.getElementById('restockDate').value;
        if (!restockDate) {
            showErrorToast('Vui lòng chọn ngày');
            return;
        }
        
        // Chuyển định dạng từ YYYY-MM-DD sang DD/MM/YYYY
        const [year, month, day] = restockDate.split('-');
        const dateStr = `${day}/${month}/${year}`;
        
        // Tìm sản phẩm từ ID
        const product = products.find(p => p[0] == productId);
        if (!product) {
            showErrorToast('Không tìm thấy sản phẩm');
            return;
        }
        
        // Lấy dữ liệu tồn kho cho ngày đã chọn
        const response = await fetch(`${API_BASE_URL}/inventory?date=${dateStr}`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho');
        }
        const inventoryData = await response.json();
        
        // Tìm tồn kho hiện tại của sản phẩm
        const inventory = inventoryData.find(item => item[2] === product[2]);
        const currentInventory = inventory ? parseInt(inventory[3]) : 0;
        
        // Thêm vào danh sách lên hàng
        restockList.push({
            id: productId,
            ncc: product[1],
            tenHang: product[2],
            tonHienTai: currentInventory,
            tonToiThieu: product[4],
            gia: product[5],
            canDat: parseInt(quantity),
            thanhTien: product[5] * parseInt(quantity)
        });
        
        // Cập nhật bảng lên hàng
        updateRestockTable();
        
        // Đóng modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addRestockModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('restockProductId').value = '';
        document.getElementById('restockQuantity').value = '';
    } catch (error) {
        console.error('Error adding restock item:', error);
        showErrorToast('Lỗi khi thêm hàng vào danh sách lên hàng');
    }
}

// Xóa hàng khỏi danh sách lên hàng
function removeRestockItem(index) {
    restockList.splice(index, 1);
    updateRestockTable();
}

// Lọc danh sách lên hàng theo NCC
function filterRestockByNcc() {
    const nccFilter = document.getElementById('restockNcc').value;
    
    const rows = document.querySelectorAll('#restockTable tbody tr');
    let totalAmount = 0;
    
    rows.forEach(row => {
        const nccCell = row.cells[1]; // Cột NCC
        if (nccFilter === '' || nccCell.textContent === nccFilter) {
            row.style.display = '';
            
            // Cộng vào tổng tiền nếu hàng được hiển thị
            const amountCell = row.cells[7]; // Cột Thành tiền
            const amountText = amountCell.textContent;
            // Loại bỏ ký tự không phải số và chuyển thành số
            const amount = parseFloat(amountText.replace(/[^\d]/g, '')) || 0;
            totalAmount += amount;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Cập nhật tổng tiền theo bộ lọc
    document.getElementById('restockTotalAmount').textContent = formatCurrency(totalAmount);
}

// Xuất Excel danh sách lên hàng
function exportRestockToExcel() {
    if (restockList.length === 0) {
        showErrorToast('Không có dữ liệu để xuất');
        return;
    }
    
    // Lấy ngày đã chọn
    const restockDate = document.getElementById('restockDate').value;
    let fileName;
    
    if (restockDate) {
        fileName = `DanhSachLenHang_${restockDate}.xlsx`;
    } else {
        fileName = `DanhSachLenHang_${new Date().toISOString().split('T')[0]}.xlsx`;
    }
    
    // Tạo dữ liệu cho Excel
    const table = document.getElementById('restockTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Danh Sách Lên Hàng"});
    
    // Xuất file
    XLSX.writeFile(wb, fileName);
}

// Load bảng người dùng
async function loadUserTable() {
    if (!requireAdmin()) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/users`);
        if (!response.ok) {
            throw new Error('Lỗi khi tải danh sách người dùng');
        }
        users = await response.json();
        
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        
        users.forEach((user, index) => {
            const row = document.createElement('tr');
            
            // STT
            const sttCell = document.createElement('td');
            sttCell.textContent = index + 1;
            row.appendChild(sttCell);
            
            // Tên đăng nhập
            const usernameCell = document.createElement('td');
            usernameCell.textContent = user[1];
            row.appendChild(usernameCell);
            
            // Mật khẩu (hiển thị dưới dạng *)
            const passwordCell = document.createElement('td');
            passwordCell.textContent = '*'.repeat(user[2].length);
            row.appendChild(passwordCell);
            
            // Quyền
            const roleCell = document.createElement('td');
            roleCell.textContent = user[3];
            row.appendChild(roleCell);
            
            // Nút hành động
            const actionCell = document.createElement('td');
            actionCell.innerHTML = `
                <button class="btn btn-sm btn-primary" onclick="editUser(${user[0]})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user[0]})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            row.appendChild(actionCell);
            
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading user table:', error);
        alert('Lỗi khi tải bảng người dùng');
    }
}

// Hiển thị form thêm người dùng
function showAddUserForm() {
    if (!requireAdmin()) return;
    
    document.getElementById('userId').value = '';
    document.getElementById('userTenDangNhap').value = '';
    document.getElementById('userMatKhau').value = '';
    document.getElementById('userQuyen').value = 'user';
    
    document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-plus me-2"></i>Thêm Người Dùng';
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

// Sửa người dùng
function editUser(id) {
    if (!requireAdmin()) return;
    
    const user = users.find(u => u[0] == id);
    if (!user) {
        alert('Không tìm thấy người dùng');
        return;
    }
    
    document.getElementById('userId').value = user[0];
    document.getElementById('userTenDangNhap').value = user[1];
    document.getElementById('userMatKhau').value = user[2];
    document.getElementById('userQuyen').value = user[3];
    
    document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-plus me-2"></i>Sửa Người Dùng';
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

// Lưu người dùng
async function saveUser() {
    const userId = document.getElementById('userId').value;
    const tenDangNhap = document.getElementById('userTenDangNhap').value;
    const matKhau = document.getElementById('userMatKhau').value;
    const quyen = document.getElementById('userQuyen').value;
    
    if (!tenDangNhap || !matKhau) {
        alert('Vui lòng nhập đầy đủ thông tin');
        return;
    }
    
    try {
        let url, method;
        if (userId) {
            // Cập nhật người dùng
            url = `${API_BASE_URL}/users/${userId}`;
            method = 'PUT';
        } else {
            // Thêm người dùng mới
            url = `${API_BASE_URL}/users`;
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ten_dang_nhap: tenDangNhap,
                mat_khau: matKhau,
                quyen: quyen
            })
        });
        
        if (response.ok) {
            alert(userId ? 'Cập nhật thành công' : 'Thêm thành công');
            const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
            modal.hide();
            loadUsers().then(() => {
                loadUserTable();
            });
        } else {
            const errorData = await response.json();
            alert(`Lỗi khi lưu dữ liệu: ${errorData.message || 'Không xác định'}`);
        }
    } catch (error) {
        console.error('Error saving user:', error);
        alert('Lỗi khi lưu dữ liệu');
    }
}

// Xóa người dùng
async function deleteUser(id) {
    if (!requireAdmin()) return;
    
    if (!confirm('Bạn có chắc chắn muốn xóa người dùng này?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/users/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Xóa thành công');
            loadUsers().then(() => {
                loadUserTable();
            });
        } else {
            alert('Lỗi khi xóa người dùng');
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        alert('Lỗi khi xóa người dùng');
    }
}

// Hàm thiết lập kéo thả cho bảng sản phẩm
function setupProductDragAndDrop() {
    const table = document.getElementById('productTable');
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        row.draggable = true;
        row.classList.add('draggable');
        
        row.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            e.dataTransfer.setData('text/plain', this.rowIndex);
        });
        
        row.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            
            // Xóa tất cả các lớp drag-over
            rows.forEach(r => r.classList.remove('drag-over'));
        });
        
        row.addEventListener('dragover', function(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            e.dataTransfer.dropEffect = 'move';
            
            // Thêm hiệu ứng visual
            const draggingRow = tbody.querySelector('.dragging');
            if (draggingRow !== this) {
                rows.forEach(r => r.classList.remove('drag-over'));
                this.classList.add('drag-over');
            }
            
            return false;
        });
        
        row.addEventListener('drop', function(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const draggingRow = tbody.querySelector('.dragging');
            const draggingIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const targetIndex = this.rowIndex;
            
            if (draggingIndex !== targetIndex) {
                // Di chuyển hàng trong DOM
                if (draggingIndex < targetIndex) {
                    this.parentNode.insertBefore(draggingRow, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggingRow, this);
                }
                
                // Cập nhật lại STT
                updateProductStt();
            }
            
            return false;
        });
    });
}

// Cập nhật lại STT trong bảng
function updateProductStt() {
    const rows = document.querySelectorAll('#productTable tbody tr');
    rows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
    });
}

// Lưu vị trí mới vào database
async function saveProductOrder() {
    if (!requireAdmin()) return;
    
    // Hiển thị loading
    showLoading();
    
    const rows = document.querySelectorAll('#productTable tbody tr');
    const productOrder = [];
    
    rows.forEach((row, index) => {
        // Lấy ID sản phẩm từ nút sửa
        const editButton = row.querySelector('button[onclick^="editProduct"]');
        if (editButton) {
            const onclickAttr = editButton.getAttribute('onclick');
            const productId = onclickAttr.match(/editProduct\((\d+)\)/)[1];
            productOrder.push({
                id: parseInt(productId),
                stt: index + 1
            });
        }
    });
    
    console.log('Dữ liệu vị trí sản phẩm:', productOrder); // Debug log
    
    try {
        const response = await fetch(`${API_BASE_URL}/products/reorder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                products: productOrder
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            console.error('Lỗi từ server:', result);
            throw new Error(result.error || 'Lỗi khi cập nhật vị trí sản phẩm');
        }
        
        if (result.success) {
            console.log('Cập nhật vị trí sản phẩm thành công');
            // Tải lại danh sách sản phẩm để đảm bảo dữ liệu đồng bộ
            await loadProducts();
            // Tải lại bảng sản phẩm
            await loadProductTable();
            
            // Hiển thị thông báo thành công
            showSuccessToast('Cập nhật vị trí sản phẩm thành công!');
        } else {
            throw new Error('Cập nhật vị trí sản phẩm không thành công');
        }
    } catch (error) {
        console.error('Error saving product order:', error);
        // Hiển thị thông báo lỗi
        showErrorToast('Lỗi khi cập nhật vị trí sản phẩm: ' + error.message);
    } finally {
        // Ẩn loading
        hideLoading();
    }
}

// Hàm hiển thị thông báo thành công
function showSuccessToast(message) {
    // Tạo một toast thông báo thành công
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0';
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Thêm toast vào container
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    // Hiển thị toast
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // Xóa toast container sau khi toast bị ẩn
    toast.addEventListener('hidden.bs.toast', function () {
        document.body.removeChild(toastContainer);
    });
}

// Hàm hiển thị thông báo lỗi
function showErrorToast(message) {
    // Tạo một toast thông báo lỗi
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0';
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Thêm toast vào container
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    // Hiển thị toast
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // Xóa toast container sau khi toast bị ẩn
    toast.addEventListener('hidden.bs.toast', function () {
        document.body.removeChild(toastContainer);
    });
}



// Thiết lập chế độ sửa trực tiếp cho bảng tồn kho
function setupEditableInventoryTable() {
    const table = document.getElementById('inventoryTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr');
    const currentDate = new Date();
    const currentDay = currentDate.getDate();
    const currentMonthNum = currentDate.getMonth() + 1;
    const currentYearNum = currentDate.getFullYear();
    
    rows.forEach(row => {
        const productName = row.cells[2].textContent; // Tên hàng ở cột thứ 3
        
        // Bắt đầu từ cột thứ 5 (tồn đầu) và các cột ngày
        for (let i = 4; i < row.cells.length; i++) {
            const cell = row.cells[i];
            // Xác định ngày tương ứng với cột này
            let day;
            if (i === 4) {
                day = 1; // Cột tồn đầu tương ứng với ngày 1
            } else {
                day = i - 4; // Các cột ngày tiếp theo
            }
            
            // Kiểm tra xem ngày này có phải là ngày trong quá khứ không
            // Đối với tồn đầu (ngày 1), luôn cho phép chỉnh sửa
            const isPastDay = (day === 1) || 
                             (currentYearNum > currentYear) ||
                             (currentYearNum === currentYear && currentMonthNum > currentMonth) ||
                             (currentYearNum === currentYear && currentMonthNum === currentMonth && day < currentDay);
            
            if (isPastDay) {
                // Thêm class để chỉ ra rằng ô này có thể chỉnh sửa
                cell.classList.add('editable-cell');
                
                // Thêm biểu tượng chỉnh sửa
                const editIcon = document.createElement('i');
                editIcon.className = 'bi bi-pencil-square edit-icon';
                cell.appendChild(editIcon);
                
                // Thêm sự kiện click để chỉnh sửa
                cell.addEventListener('click', function() {
                    makeCellEditable(this, productName, day);
                });
            }
        }
    });
}

// Hàm để làm cho một ô trở nên có thể chỉnh sửa
function makeCellEditable(cell, productName, day) {
    // Nếu ô đang ở chế độ chỉnh sửa, không làm gì cả
    if (cell.classList.contains('editing')) return;
    
    // Lưu giá trị hiện tại
    const currentValue = cell.textContent.trim();
    
    // Lưu giá trị gốc vào thuộc tính data để sử dụng sau này
    cell.dataset.originalValue = currentValue;
    
    // Lấy màu nền và màu chữ từ thuộc tính data
    const originalBgColor = cell.dataset.originalBgColor;
    const originalTextColor = cell.dataset.originalTextColor;
    
    // Thêm class editing
    cell.classList.add('editing');
    
    // Tạo input để chỉnh sửa
    const input = document.createElement('input');
    input.type = 'number';
    input.value = currentValue === '' ? '0' : currentValue;
    input.className = 'form-control';
    input.style.width = '100%';
    input.style.textAlign = 'center';
    
    // Xóa nội dung hiện tại của ô và thay bằng input
    cell.innerHTML = '';
    cell.appendChild(input);
    
    // Focus vào input
    input.focus();
    input.select();
    
    // Xử lý sự kiện khi người dùng nhấn Enter hoặc rời khỏi input
    input.addEventListener('blur', function() {
        saveCellEdit(cell, productName, day, this.value);
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveCellEdit(cell, productName, day, this.value);
        } else if (e.key === 'Escape') {
            // Hủy chỉnh sửa
            cell.classList.remove('editing');
            cell.textContent = cell.dataset.originalValue;
            cell.style.backgroundColor = originalBgColor;
            cell.style.color = originalTextColor;
            
            // Thêm lại biểu tượng chỉnh sửa
            const editIcon = document.createElement('i');
            editIcon.className = 'bi bi-pencil-square edit-icon';
            cell.appendChild(editIcon);
        }
    });
}

// Hàm để lưu chỉnh sửa của ô
async function saveCellEdit(cell, productName, day, newValue) {
    // Loại bỏ class editing
    cell.classList.remove('editing');
    
    // Lấy giá trị gốc từ thuộc tính data
    const originalValue = cell.dataset.originalValue || '';
    const originalBgColor = cell.dataset.originalBgColor || '';
    
    // Kiểm tra giá trị mới
    if (newValue === '' || isNaN(newValue)) {
        cell.textContent = originalValue;
        cell.style.backgroundColor = originalBgColor;
        
        // Thêm lại biểu tượng chỉnh sửa
        const editIcon = document.createElement('i');
        editIcon.className = 'bi bi-pencil-square edit-icon';
        cell.appendChild(editIcon);
        return;
    }
    
    const value = parseInt(newValue);
    
    // Nếu giá trị không thay đổi, không cần cập nhật
    if (value.toString() === originalValue) {
        cell.textContent = originalValue;
        cell.style.backgroundColor = originalBgColor;
        
        // Thêm lại biểu tượng chỉnh sửa
        const editIcon = document.createElement('i');
        editIcon.className = 'bi bi-pencil-square edit-icon';
        cell.appendChild(editIcon);
        return;
    }
    
    // Hiển thị loading
    showLoading();
    
    try {
        // Xử lý đặc biệt cho tồn đầu (ngày 1)
        let dateStr;
        if (day === 1) {
            // Đối với tồn đầu, lưu vào ngày cuối cùng của tháng trước
            const prevMonthLastDay = new Date(currentYear, currentMonth - 1, 0).getDate();
            const prevMonth = currentMonth - 1 === 0 ? 12 : currentMonth - 1;
            const prevYear = currentMonth - 1 === 0 ? currentYear - 1 : currentYear;
            
            dateStr = `${String(prevMonthLastDay).padStart(2, '0')}/${String(prevMonth).padStart(2, '0')}/${prevYear}`;
        } else {
            // Với các ngày khác, sử dụng ngày hiện tại
            dateStr = `${String(day).padStart(2, '0')}/${String(currentMonth).padStart(2, '0')}/${currentYear}`;
        }
        
        // Tìm ID sản phẩm từ tên
        const product = products.find(p => p[2] === productName);
        if (!product) {
            showErrorToast('Không tìm thấy sản phẩm');
            return;
        }
        
        // Kiểm tra xem đã có bản ghi cho ngày và sản phẩm này chưa
        const existingRecord = inventoryData.find(item => 
            item[1] === dateStr && item[2] === productName
        );
        
        let response;
        if (existingRecord) {
            // Nếu đã có bản ghi, cập nhật bằng POST kèm theo id
            response = await fetch(`${API_BASE_URL}/inventory`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: existingRecord[0], // Gửi kèm id để server biết đây là cập nhật
                    ngay: dateStr,
                    id_san_pham: product[0],
                    so_luong: value
                })
            });
        } else {
            // Nếu chưa có bản ghi, thêm mới
            response = await fetch(`${API_BASE_URL}/inventory`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ngay: dateStr,
                    id_san_pham: product[0],
                    so_luong: value
                })
            });
        }
        
        if (response.ok) {
            // Cập nhật lại dữ liệu trong biến inventoryData
            if (existingRecord) {
                existingRecord[3] = value;
            } else {
                // Thêm bản ghi mới vào inventoryData
                const newId = inventoryData.length > 0 ? Math.max(...inventoryData.map(item => item[0])) + 1 : 1;
                inventoryData.push([newId, dateStr, productName, value]);
            }
            
            // Cập nhật lại ô trong bảng
            cell.textContent = value;
            cell.style.backgroundColor = originalBgColor;
            
            // Thêm lại biểu tượng chỉnh sửa
            const editIcon = document.createElement('i');
            editIcon.className = 'bi bi-pencil-square edit-icon';
            cell.appendChild(editIcon);
            
            // Nếu là tồn đầu (ngày 1), tải lại bảng để cập nhật các ngày còn lại
            if (day === 1) {
                loadInventoryTable();
            }
            
            showSuccessToast('Cập nhật tồn kho thành công!');
        } else {
            showErrorToast('Lỗi khi cập nhật tồn kho');
            // Khôi phục giá trị cũ
            cell.textContent = originalValue;
            cell.style.backgroundColor = originalBgColor;
            
            // Thêm lại biểu tượng chỉnh sửa
            const editIcon = document.createElement('i');
            editIcon.className = 'bi bi-pencil-square edit-icon';
            cell.appendChild(editIcon);
        }
    } catch (error) {
        console.error('Error saving inventory edit:', error);
        showErrorToast('Lỗi khi cập nhật tồn kho');
        // Khôi phục giá trị cũ
        cell.textContent = originalValue;
        cell.style.backgroundColor = originalBgColor;
        
        // Thêm lại biểu tượng chỉnh sửa
        const editIcon = document.createElement('i');
        editIcon.className = 'bi bi-pencil-square edit-icon';
        cell.appendChild(editIcon);
    } finally {
        // Ẩn loading
        hideLoading();
    }
}

// Import sản phẩm từ file Excel
function importProductsFromExcel(input) {
    const file = input.files[0];
    if (!file) return;

    // Kiểm tra định dạng file
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        showErrorToast('Vui lòng chọn file Excel (.xlsx, .xls)');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Kiểm tra dữ liệu
            if (jsonData.length < 2) {
                showErrorToast('File không có dữ liệu hoặc chỉ có header');
                return;
            }

            // Xác nhận trước khi import
            if (!confirm(`Bạn có chắc chắn muốn import ${jsonData.length - 1} sản phẩm?`)) {
                return;
            }

            // Bỏ qua hàng đầu tiên (header)
            const productsToImport = jsonData.slice(1);

            // Xử lý từng sản phẩm
            importProductsSequentially(productsToImport, 0);
        } catch (error) {
            console.error('Error reading Excel file:', error);
            showErrorToast('Lỗi khi đọc file Excel: ' + error.message);
        }
    };
    reader.onerror = function() {
        showErrorToast('Lỗi khi đọc file');
    };
    reader.readAsArrayBuffer(file);

    // Reset input để có thể chọn lại cùng một file
    input.value = '';
}

// Import sản phẩm tuần tự (để tránh gửi quá nhiều request cùng lúc)
async function importProductsSequentially(products, index) {
    // Hiển thị modal nếu là sản phẩm đầu tiên
    if (index === 0) {
        const modal = new bootstrap.Modal(document.getElementById('importProgressModal'));
        modal.show();
        
        // Cập nhật tổng số sản phẩm
        document.getElementById('importProgressText').textContent = `0/${products.length}`;
        document.getElementById('importProgressBar').style.width = '0%';
        document.getElementById('importProgressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('importProgressBar').textContent = '0%';
        document.getElementById('importStatus').textContent = 'Đang chuẩn bị import...';
    }

    if (index >= products.length) {
        // Import hoàn tất
        document.getElementById('importProgressText').textContent = `${products.length}/${products.length}`;
        document.getElementById('importProgressBar').style.width = '100%';
        document.getElementById('importProgressBar').setAttribute('aria-valuenow', '100');
        document.getElementById('importProgressBar').textContent = '100%';
        document.getElementById('importStatus').className = 'alert alert-success';
        document.getElementById('importStatus').textContent = `Import thành công ${products.length} sản phẩm!`;
        
        // Cập nhật nút footer
        const footer = document.querySelector('#importProgressModal .modal-footer');
        footer.innerHTML = '<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>';
        
        // Tải lại danh sách sản phẩm
        loadProducts().then(() => {
            loadProductTable();
        });
        
        return;
    }

    const product = products[index];
    
    // Kiểm tra cấu trúc dữ liệu
    if (!product || product.length < 6) {
        console.warn('Bỏ qua sản phẩm không đủ dữ liệu:', product);
        // Cập nhật tiến trình và chuyển sang sản phẩm tiếp theo
        updateImportProgress(index + 1, products.length, `Bỏ qua sản phẩm không đủ dữ liệu: ${product ? product[1] : 'không xác định'}`);
        setTimeout(() => importProductsSequentially(products, index + 1), 100);
        return;
    }

    try {
        // Chuẩn bị dữ liệu sản phẩm
        const productData = {
            ncc: product[0] || '',
            ten_hang: product[1] || '',
            dvt: product[2] || '',
            ton_toi_thieu: parseInt(product[3]) || 0,
            gia: parseInt(product[4]) || 0,
            mau_ncc: product[5] || '#4CAF50' // Mặc định màu xanh nếu không có
        };

        // Kiểm tra các trường bắt buộc
        if (!productData.ncc || !productData.ten_hang || !productData.dvt) {
            console.warn('Bỏ qua sản phẩm thiếu thông tin bắt buộc:', productData);
            // Cập nhật tiến trình và chuyển sang sản phẩm tiếp theo
            updateImportProgress(index + 1, products.length, `Bỏ qua sản phẩm thiếu thông tin: ${productData.ten_hang || 'không xác định'}`);
            setTimeout(() => importProductsSequentially(products, index + 1), 100);
            return;
        }

        // Cập nhật trạng thái
        document.getElementById('importStatus').textContent = `Đang import sản phẩm: ${productData.ten_hang}`;

        // Gửi request để thêm sản phẩm
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
        });

        if (response.ok) {
            // Cập nhật tiến trình
            updateImportProgress(index + 1, products.length, `Đã import thành công: ${productData.ten_hang}`);
            // Chuyển sang sản phẩm tiếp theo
            setTimeout(() => importProductsSequentially(products, index + 1), 100);
        } else {
            console.error('Lỗi khi import sản phẩm:', productData);
            // Cập nhật tiến trình và vẫn tiếp tục với sản phẩm tiếp theo
            updateImportProgress(index + 1, products.length, `Lỗi khi import: ${productData.ten_hang}`);
            setTimeout(() => importProductsSequentially(products, index + 1), 100);
        }
    } catch (error) {
        console.error('Error importing product:', error);
        // Cập nhật tiến trình và vẫn tiếp tục với sản phẩm tiếp theo
        updateImportProgress(index + 1, products.length, `Lỗi khi import: ${productData.ten_hang}`);
        setTimeout(() => importProductsSequentially(products, index + 1), 100);
    }
}

// Cập nhật tiến trình import
function updateImportProgress(current, total, status = '') {
    const percentage = Math.round((current / total) * 100);
    document.getElementById('importProgressText').textContent = `${current}/${total}`;
    document.getElementById('importProgressBar').style.width = `${percentage}%`;
    document.getElementById('importProgressBar').setAttribute('aria-valuenow', percentage);
    document.getElementById('importProgressBar').textContent = `${percentage}%`;
    
    if (status) {
        document.getElementById('importStatus').textContent = status;
    }
}

// Hàm lưu dữ liệu tồn kho
async function saveInventoryData(productId, day, quantity) {
    try {
        // Lấy tháng/năm hiện tại từ dropdown
        const monthYearSelect = document.getElementById('inventoryMonth');
        if (!monthYearSelect) {
            showErrorToast('Không tìm thấy dropdown tháng/năm');
            return;
        }
        
        let monthYear = monthYearSelect.value;
        if (!monthYear) {
            // Nếu không có giá trị, sử dụng tháng/năm hiện tại
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            monthYear = `${year}-${month}`;
            monthYearSelect.value = monthYear;
        }
        
        // Phân tách tháng và năm
        const [year, month] = monthYear.split('-');
        
        // Tạo định dạng ngày dd/mm/yyyy
        const dateStr = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        
        // Chuyển đổi định dạng ngày từ dd/mm/yyyy thành yyyy-mm-dd cho MySQL
        const mysqlDate = `${year}-${month}-${String(day).padStart(2, '0')}`;
        
        console.log('Đang lưu với ngày:', mysqlDate); // Debug log
        
        // Hiển thị loading
        showLoading();
        
        // Kiểm tra xem đã có bản ghi cho ngày và sản phẩm này chưa
        const checkResponse = await fetch(`${API_BASE_URL}/inventory/check`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ngay: mysqlDate,
                id_san_pham: productId
            })
        });
        
        if (!checkResponse.ok) {
            throw new Error('Lỗi khi kiểm tra dữ liệu tồn kho');
        }
        
        const checkResult = await checkResponse.json();
        
        let response;
        if (checkResult.exists) {
            // Cập nhật bản ghi hiện có
            response = await fetch(`${API_BASE_URL}/inventory`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ngay: mysqlDate,
                    id_san_pham: productId,
                    so_luong: quantity
                })
            });
        } else {
            // Thêm bản ghi mới
            response = await fetch(`${API_BASE_URL}/inventory`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ngay: mysqlDate,
                    id_san_pham: productId,
                    so_luong: quantity
                })
            });
        }
        
        if (!response.ok) {
            throw new Error('Lỗi khi lưu dữ liệu tồn kho');
        }
        
        // Cập nhật lại dữ liệu trong biến inventoryData
        const inventoryItem = [
            0, // ID (sẽ được tạo bởi database)
            dateStr,
            products.find(p => p[0] === productId)[2], // Tên hàng
            quantity
        ];
        
        // Tìm và cập nhật hoặc thêm mới vào inventoryData
        const existingIndex = inventoryData.findIndex(item => 
            item[1] === dateStr && item[2] === products.find(p => p[0] === productId)[2]
        );
        
        if (existingIndex !== -1) {
            inventoryData[existingIndex][3] = quantity;
        } else {
            inventoryData.push(inventoryItem);
        }
        
        // Hiển thị thông báo thành công
        showSuccessToast('Cập nhật tồn kho thành công!');
    } catch (error) {
        console.error('Error saving inventory data:', error);
        showErrorToast('Lỗi khi lưu dữ liệu tồn kho: ' + error.message);
    } finally {
        // Ẩn loading
        hideLoading();
    }
}

// Tải mẫu file Excel import sản phẩm
function downloadProductTemplate() {
    // Tạo dữ liệu mẫu
    const templateData = [
        ['NCC', 'Tên hàng', 'ĐVT', 'Tồn tối thiểu', 'Giá', 'Màu NCC'],
        ['NPHP', 'Nước ngọt NPHP', 'Chai', 50, 10000, '#4CAF50'],
        ['CỐT LÕI', 'Bánh kẹo CỐT LÕI', 'Hộp', 30, 25000, '#FFC0CB'],
        ['KHÁC', 'Sản phẩm khác', 'Cái', 20, 15000, '#FFA500']
    ];

    // Tạo workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);

    // Thêm worksheet vào workbook
    XLSX.utils.book_append_sheet(wb, ws, "Mẫu Import Sản Phẩm");

    // Xuất file
    XLSX.writeFile(wb, "Mau_Import_San_Pham.xlsx");
}

// Hiển thị modal xóa dữ liệu
function showDeleteDataModal() {
    if (!requireAdmin()) return;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteDataModal'));
    
    // Reset form
    document.getElementById('deleteByNccOption').checked = true;
    document.getElementById('nccSelect').value = '';
    document.getElementById('confirmDelete').checked = false;
    document.getElementById('confirmDeleteButton').disabled = true;
    
    // Hiển thị modal
    modal.show();
    
    // Thiết lập sự kiện cho các radio button
    document.querySelectorAll('input[name="deleteOption"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const nccSelection = document.getElementById('nccSelection');
            if (this.value === 'ncc') {
                nccSelection.style.display = 'block';
            } else {
                nccSelection.style.display = 'none';
            }
        });
    });
    
    // Thiết lập sự kiện cho checkbox xác nhận
    document.getElementById('confirmDelete').addEventListener('change', function() {
        document.getElementById('confirmDeleteButton').disabled = !this.checked;
    });
    
    // Thiết lập sự kiện cho nút xóa
    document.getElementById('confirmDeleteButton').onclick = function() {
        const deleteOption = document.querySelector('input[name="deleteOption"]:checked').value;
        const ncc = document.getElementById('nccSelect').value;
        
        // Ẩn modal
        modal.hide();
        
        // Xác nhận lần cuối
        let confirmMessage = '';
        if (deleteOption === 'all') {
            confirmMessage = 'Bạn có chắc chắn muốn xóa TOÀN BỘ dữ liệu (sản phẩm và tồn kho)?';
        } else if (deleteOption === 'ncc') {
            if (!ncc) {
                showErrorToast('Vui lòng chọn NCC cần xóa');
                return;
            }
            confirmMessage = `Bạn có chắc chắn muốn xóa tất cả dữ liệu của NCC "${ncc}"?`;
        } else if (deleteOption === 'products') {
            confirmMessage = 'Bạn có chắc chắn muốn xóa tất cả sản phẩm (giữ lại dữ liệu tồn kho)?';
        } else if (deleteOption === 'inventory') {
            confirmMessage = 'Bạn có chắc chắn muốn xóa tất cả dữ liệu tồn kho (giữ lại sản phẩm)?';
        }
        
        if (confirm(confirmMessage)) {
            // Hiển thị loading
            showLoading();
            
            // Gọi API xóa dữ liệu
            deleteData(deleteOption, ncc);
        }
    };
}

// Xóa dữ liệu
async function deleteData(option, ncc = '') {
    try {
        let url = `${API_BASE_URL}/delete-data`;
        let body = { option };
        
        if (option === 'ncc') {
            body.ncc = ncc;
        }
        
        const response = await fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        
        if (response.ok) {
            const result = await response.json();
            showSuccessToast(result.message || 'Xóa dữ liệu thành công');
            
            // Tải lại danh sách sản phẩm
            await loadProducts();
            loadProductTable();
            
            // Nếu đang ở tab tồn kho, tải lại bảng tồn kho
            const inventoryTab = document.getElementById('inventory-tab');
            if (inventoryTab.classList.contains('active')) {
                await loadInventoryTable();
            }
            
            // Nếu đang ở tab lên hàng, tải lại bảng lên hàng
            const restockTab = document.getElementById('restock-tab');
            if (restockTab.classList.contains('active')) {
                generateRestockList();
            }
        } else {
            const error = await response.json();
            showErrorToast(error.error || 'Lỗi khi xóa dữ liệu');
        }
    } catch (error) {
        console.error('Error deleting data:', error);
        showErrorToast('Lỗi khi xóa dữ liệu');
    } finally {
        hideLoading();
    }
}

// Tải mẫu file Excel import tồn kho
function downloadInventoryTemplate() {
    // Tạo dữ liệu mẫu
    const templateData = [
        ['Ngày', 'Tên hàng', 'Số lượng tồn kho'],
        ['15/09/2025', 'Nước ngọt NPHP', 100],
        ['15/09/2025', 'Bánh kẹo CỐT LÕI', 50],
        ['16/09/2025', 'Nước ngọt NPHP', 95],
        ['16/09/2025', 'Bánh kẹo CỐT LÕI', 45]
    ];

    // Tạo workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);

    // Thêm worksheet vào workbook
    XLSX.utils.book_append_sheet(wb, ws, "Mẫu Import Tồn Kho");

    // Xuất file
    XLSX.writeFile(wb, "Mau_Import_Ton_Kho.xlsx");
}

// Import tồn kho từ file Excel
function importInventoryFromExcel(input) {
    const file = input.files[0];
    if (!file) return;

    // Kiểm tra định dạng file
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        showErrorToast('Vui lòng chọn file Excel (.xlsx, .xls)');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Kiểm tra dữ liệu
            if (jsonData.length < 2) {
                showErrorToast('File không có dữ liệu hoặc chỉ có header');
                return;
            }

            // Bỏ qua hàng đầu tiên (header)
            const inventoryData = jsonData.slice(1);

            // Kiểm tra xem có dữ liệu trùng không
            let hasDuplicates = false;
            const duplicateDates = [];
            
            for (const item of inventoryData) {
                if (item && item.length >= 2) {
                    const date = item[0] || '';
                    const productName = item[1] || '';
                    
                    if (date && productName) {
                        // Kiểm tra xem đã có dữ liệu cho ngày và sản phẩm này chưa
                        const exists = inventoryData.some(inv => 
                            inv[1] === date && inv[2] === productName
                        );
                        if (exists) {
                            hasDuplicates = true;
                            if (!duplicateDates.includes(date)) {
                                duplicateDates.push(date);
                            }
                        }
                    }
                }
            }
            
            // Nếu có dữ liệu trùng, hiển thị modal lựa chọn
            if (hasDuplicates) {
                const modal = new bootstrap.Modal(document.getElementById('importInventoryOptionModal'));
                
                // Hiển thị một số ngày trùng
                const dateList = duplicateDates.slice(0, 3).join(', ');
                const moreText = duplicateDates.length > 3 ? ` và ${duplicateDates.length - 3} ngày khác` : '';
                document.querySelector('#importInventoryOptionModal .modal-body p').innerHTML = 
                    `Phát hiện dữ liệu tồn kho trong file Excel đã tồn tại trong hệ thống (${dateList}${moreText}). Bạn muốn:`;
                
                // Thiết lập sự kiện cho nút xác nhận
                document.getElementById('confirmInventoryImportOption').onclick = function() {
                    const selectedOption = document.querySelector('input[name="inventoryDuplicateOption"]:checked').value;
                    modal.hide();
                    
                    // Lưu lựa chọn vào biến toàn cục
                    window.inventoryDuplicateOption = selectedOption;
                    
                    // Bắt đầu import
                    importInventorySequentially(inventoryData, 0);
                };
                
                // Hiển thị modal
                modal.show();
            } else {
                // Không có dữ liệu trùng, bắt đầu import ngay
                window.inventoryDuplicateOption = 'update'; // Mặc định là cập nhật
                importInventorySequentially(inventoryData, 0);
            }
        } catch (error) {
            console.error('Error reading Excel file:', error);
            showErrorToast('Lỗi khi đọc file Excel: ' + error.message);
        }
    };
    reader.onerror = function() {
        showErrorToast('Lỗi khi đọc file');
    };
    reader.readAsArrayBuffer(file);

    // Reset input để có thể chọn lại cùng một file
    input.value = '';
}

// Import tồn kho tuần tự
async function importInventorySequentially(inventoryData, index) {
    // Hiển thị modal nếu là mục đầu tiên
    if (index === 0) {
        const modal = new bootstrap.Modal(document.getElementById('importInventoryProgressModal'));
        modal.show();
        
        // Cập nhật tổng số mục
        document.getElementById('importInventoryProgressText').textContent = `0/${inventoryData.length}`;
        document.getElementById('importInventoryProgressBar').style.width = '0%';
        document.getElementById('importInventoryProgressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('importInventoryProgressBar').textContent = '0%';
        document.getElementById('importInventoryStatus').textContent = 'Đang chuẩn bị import...';
    }

    if (index >= inventoryData.length) {
        // Import hoàn tất
        document.getElementById('importInventoryProgressText').textContent = `${inventoryData.length}/${inventoryData.length}`;
        document.getElementById('importInventoryProgressBar').style.width = '100%';
        document.getElementById('importInventoryProgressBar').setAttribute('aria-valuenow', '100');
        document.getElementById('importInventoryProgressBar').textContent = '100%';
        document.getElementById('importInventoryStatus').className = 'alert alert-success';
        document.getElementById('importInventoryStatus').textContent = `Import thành công ${inventoryData.length} bản ghi tồn kho!`;
        
        // Cập nhật nút footer
        const footer = document.querySelector('#importInventoryProgressModal .modal-footer');
        footer.innerHTML = '<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>';
        
        // Tải lại bảng tồn kho
        loadInventoryTable();
        
        return;
    }

    const item = inventoryData[index];
    
    // Kiểm tra cấu trúc dữ liệu
    if (!item || item.length < 3) {
        console.warn('Bỏ qua mục không đủ dữ liệu:', item);
        updateInventoryImportProgress(index + 1, inventoryData.length, `Bỏ qua mục không đủ dữ liệu`);
        setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
        return;
    }

    try {
        // Chuẩn bị dữ liệu tồn kho
        const dateStr = item[0] || '';
        const productName = item[1] || '';
        const quantity = parseInt(item[2]) || 0;

        // Kiểm tra các trường bắt buộc
        if (!dateStr || !productName) {
            console.warn('Bỏ qua mục thiếu thông tin bắt buộc:', item);
            updateInventoryImportProgress(index + 1, inventoryData.length, `Bỏ qua mục thiếu thông tin`);
            setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
            return;
        }

        // Tìm sản phẩm từ tên
        const product = products.find(p => p[2] === productName);
        if (!product) {
            console.warn('Bỏ qua mục không tìm thấy sản phẩm:', productName);
            updateInventoryImportProgress(index + 1, inventoryData.length, `Không tìm thấy sản phẩm: ${productName}`);
            setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
            return;
        }

        // Cập nhật trạng thái
        document.getElementById('importInventoryStatus').textContent = `Đang xử lý: ${productName} - ${dateStr}`;

        // Kiểm tra xem đã có dữ liệu tồn kho cho ngày và sản phẩm này chưa
        const existingRecord = inventoryData.find(inv => 
            inv[1] === dateStr && inv[2] === productName
        );

        let response;
        let actionText;
        const option = window.inventoryDuplicateOption || 'update'; // Lấy lựa chọn từ biến toàn cục
        
        if (existingRecord && option !== 'overwrite') {
            if (option === 'skip') {
                // Bỏ qua dữ liệu đã tồn tại
                document.getElementById('importInventoryStatus').textContent = `Bỏ qua dữ liệu đã tồn tại: ${productName} - ${dateStr}`;
                updateInventoryImportProgress(index + 1, inventoryData.length, `Bỏ qua: ${productName} - ${dateStr}`);
                setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
                return;
            } else if (option === 'update') {
                // Cập nhật dữ liệu đã tồn tại
                actionText = "Cập nhật";
                document.getElementById('importInventoryStatus').textContent = `Cập nhật tồn kho: ${productName} - ${dateStr}`;
                
                response = await fetch(`${API_BASE_URL}/inventory/${existingRecord[0]}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ngay: dateStr,
                        id_san_pham: product[0],
                        so_luong: quantity
                    })
                });
            }
        } else {
            // Thêm mới dữ liệu tồn kho
            actionText = "Thêm mới";
            document.getElementById('importInventoryStatus').textContent = `Thêm mới tồn kho: ${productName} - ${dateStr}`;
            
            response = await fetch(`${API_BASE_URL}/inventory`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ngay: dateStr,
                    id_san_pham: product[0],
                    so_luong: quantity
                })
            });
        }

        if (response.ok) {
            // Cập nhật tiến trình
            updateInventoryImportProgress(index + 1, inventoryData.length, `${actionText} thành công: ${productName} - ${dateStr}`);
            
            // Nếu là thêm mới, cập nhật lại biến inventoryData
            if (!existingRecord || option === 'overwrite') {
                const newRecord = await response.json();
                inventoryData.push([
                    newRecord.id,
                    dateStr,
                    productName,
                    quantity
                ]);
            } else if (option === 'update') {
                // Cập nhật thông tin trong biến inventoryData
                existingRecord[3] = quantity;
            }
            
            // Chuyển sang mục tiếp theo
            setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
        } else {
            console.error('Lỗi khi import tồn kho:', item);
            updateInventoryImportProgress(index + 1, inventoryData.length, `Lỗi khi xử lý: ${productName} - ${dateStr}`);
            setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
        }
    } catch (error) {
        console.error('Error importing inventory:', error);
        updateInventoryImportProgress(index + 1, inventoryData.length, `Lỗi khi xử lý: ${productName} - ${dateStr}`);
        setTimeout(() => importInventorySequentially(inventoryData, index + 1), 100);
    }
}
// Hiển thị form nhập tồn kho
function showInventoryForm() {
    const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
    modal.show();

    // Cập nhật thông tin sản phẩm
    updateProductInfo();
    
    // Thêm lớp để cải thiện giao diện modal trên mobile
    if (window.innerWidth < 768) {
        document.getElementById('inventoryModal').classList.add('mobile-modal');
    } else {
        document.getElementById('inventoryModal').classList.remove('mobile-modal');
    }
}

// Cập nhật tiến trình import tồn kho
function updateInventoryImportProgress(current, total, status = '') {
    const percentage = Math.round((current / total) * 100);
    document.getElementById('importInventoryProgressText').textContent = `${current}/${total}`;
    document.getElementById('importInventoryProgressBar').style.width = `${percentage}%`;
    document.getElementById('importInventoryProgressBar').setAttribute('aria-valuenow', percentage);
    document.getElementById('importInventoryProgressBar').textContent = `${percentage}%`;
    
    if (status) {
        document.getElementById('importInventoryStatus').textContent = status;
    }
}
// Tải mẫu file Excel import nhập hàng
function downloadImportTemplate() {
    // Tạo dữ liệu mẫu
    const templateData = [
        ['Ngày nhập', 'Tên hàng', 'Số lượng'],
        ['15/09/2023', 'Nước ngọt NPHP', 100],
        ['15/09/2023', 'Bánh kẹo CỐT LÕI', 50],
        ['16/09/2023', 'Nước ngọt NPHP', 200],
        ['16/09/2023', 'Bánh kẹo CỐT LÕI', 75]
    ];

    // Tạo workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);

    // Thêm worksheet vào workbook
    XLSX.utils.book_append_sheet(wb, ws, "Mẫu Import Nhập Hàng");

    // Xuất file
    XLSX.writeFile(wb, "Mau_Import_Nhap_Hang.xlsx");
}

// Import nhập hàng từ file Excel
function importImportFromExcel(input) {
    const file = input.files[0];
    if (!file) return;

    // Kiểm tra định dạng file
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        showErrorToast('Vui lòng chọn file Excel (.xlsx, .xls)');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Kiểm tra dữ liệu
            if (jsonData.length < 2) {
                showErrorToast('File không có dữ liệu hoặc chỉ có header');
                return;
            }

            // Xác nhận trước khi import
            if (!confirm(`Bạn có chắc chắn muốn import ${jsonData.length - 1} mục nhập hàng?`)) {
                return;
            }

            // Bỏ qua hàng đầu tiên (header)
            const importData = jsonData.slice(1);

            // Bắt đầu import
            importImportSequentially(importData, 0);
        } catch (error) {
            console.error('Error reading Excel file:', error);
            showErrorToast('Lỗi khi đọc file Excel: ' + error.message);
        }
    };
    reader.onerror = function() {
        showErrorToast('Lỗi khi đọc file');
    };
    reader.readAsArrayBuffer(file);

    // Reset input để có thể chọn lại cùng một file
    input.value = '';
}

// Import nhập hàng tuần tự
async function importImportSequentially(importData, index) {
    // Hiển thị modal nếu là mục đầu tiên
    if (index === 0) {
        const modal = new bootstrap.Modal(document.getElementById('importImportProgressModal'));
        modal.show();
        
        // Cập nhật tổng số mục
        document.getElementById('importImportProgressText').textContent = `0/${importData.length}`;
        document.getElementById('importImportProgressBar').style.width = '0%';
        document.getElementById('importImportProgressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('importImportProgressBar').textContent = '0%';
        document.getElementById('importImportStatus').textContent = 'Đang chuẩn bị import...';
    }

    if (index >= importData.length) {
        // Import hoàn tất
        document.getElementById('importImportProgressText').textContent = `${importData.length}/${importData.length}`;
        document.getElementById('importImportProgressBar').style.width = '100%';
        document.getElementById('importImportProgressBar').setAttribute('aria-valuenow', '100');
        document.getElementById('importImportProgressBar').textContent = '100%';
        document.getElementById('importImportStatus').className = 'alert alert-success';
        document.getElementById('importImportStatus').textContent = `Import thành công ${importData.length} mục nhập hàng!`;
        
        // Cập nhật nút footer
        const footer = document.querySelector('#importImportProgressModal .modal-footer');
        footer.innerHTML = '<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>';
        
        // Reset bảng nhập hàng
        setupImportTable();
        
        return;
    }

    const item = importData[index];
    
    // Kiểm tra cấu trúc dữ liệu
    if (!item || item.length < 3) {
        console.warn('Bỏ qua mục không đủ dữ liệu:', item);
        updateImportImportProgress(index + 1, importData.length, `Bỏ qua mục không đủ dữ liệu`);
        setTimeout(() => importImportSequentially(importData, index + 1), 100);
        return;
    }

    try {
        // Chuẩn bị dữ liệu nhập hàng
        const importDate = item[0] || '';
        const productName = item[1] || '';
        const quantity = parseInt(item[2]) || 0;

        // Kiểm tra các trường bắt buộc
        if (!importDate || !productName || !quantity) {
            console.warn('Bỏ qua mục thiếu thông tin bắt buộc:', item);
            updateImportImportProgress(index + 1, importData.length, `Bỏ qua mục thiếu thông tin`);
            setTimeout(() => importImportSequentially(importData, index + 1), 100);
            return;
        }

        // Tìm sản phẩm từ tên
        const product = products.find(p => p[2] === productName);
        if (!product) {
            console.warn('Bỏ qua mục không tìm thấy sản phẩm:', productName);
            updateImportImportProgress(index + 1, importData.length, `Không tìm thấy sản phẩm: ${productName}`);
            setTimeout(() => importImportSequentially(importData, index + 1), 100);
            return;
        }

        // Cập nhật trạng thái
        document.getElementById('importImportStatus').textContent = `Đang xử lý: ${productName} - ${importDate}`;

        // Chuẩn bị dữ liệu để gửi lên server
        const importItem = {
            ngay: importDate,
            id_san_pham: product[0],
            so_luong: quantity
        };

        // Gửi request để thêm nhập hàng
        const response = await fetch(`${API_BASE_URL}/import`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(importItem)
        });

        if (response.ok) {
            // Cập nhật tiến trình
            updateImportImportProgress(index + 1, importData.length, `Import thành công: ${productName} - ${importDate}`);
            
            // Chuyển sang mục tiếp theo
            setTimeout(() => importImportSequentially(importData, index + 1), 100);
        } else {
            console.error('Lỗi khi import nhập hàng:', item);
            updateImportImportProgress(index + 1, importData.length, `Lỗi khi import: ${productName} - ${importDate}`);
            setTimeout(() => importImportSequentially(importData, index + 1), 100);
        }
    } catch (error) {
        console.error('Error importing import:', error);
        updateImportImportProgress(index + 1, importData.length, `Lỗi khi xử lý: ${productName} - ${importDate}`);
        setTimeout(() => importImportSequentially(importData, index + 1), 100);
    }
}

// Hàm hiển thị modal báo cáo ly
function showLyReportModal() {
    const modal = new bootstrap.Modal(document.getElementById('lyReportModal'));
    modal.show();
    
    // Thiết lập ngày hiện tại
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('lyReportDate').value = formattedDate;
    
    // Tải dữ liệu báo cáo
    loadLyReport();
}

// Hàm tải dữ liệu báo cáo ly
async function loadLyReport() {
    const selectedDate = document.getElementById('lyReportDate').value;
    if (!selectedDate) return;
    
    // Chuyển định dạng từ YYYY-MM-DD sang DD/MM/YYYY
    const [year, month, day] = selectedDate.split('-');
    const dateStr = `${day}/${month}/${year}`;
    
    // Tính ngày trước đó
    const prevDate = new Date(year, month - 1, day);
    prevDate.setDate(prevDate.getDate() - 1);
    const prevDateStr = formatDate(prevDate);
    
    try {
        // Hiển thị loading
        showLoading();
        
        // Lấy dữ liệu tồn kho cho ngày hiện tại và ngày trước
        const [currentInventoryResponse, prevInventoryResponse] = await Promise.all([
            fetch(`${API_BASE_URL}/inventory?date=${dateStr}`),
            fetch(`${API_BASE_URL}/inventory?date=${prevDateStr}`)
        ]);
        
        if (!currentInventoryResponse.ok || !prevInventoryResponse.ok) {
            throw new Error('Lỗi khi tải dữ liệu tồn kho');
        }
        
        const currentInventoryData = await currentInventoryResponse.json();
        const prevInventoryData = await prevInventoryResponse.json();
        
        // Thử lấy dữ liệu nhập hàng với endpoint /import
        let importData = [];
        try {
            // Thử với endpoint /import (không có 's')
            const importResponse = await fetch(`${API_BASE_URL}/import?date=${dateStr}`);
            
            if (importResponse.ok) {
                importData = await importResponse.json();
            } else {
                // Nếu không thành công, tính toán từ bảng tồn kho
                importData = await calculateImportData(dateStr, prevDateStr);
            }
        } catch (importError) {
            console.warn('Không thể tải dữ liệu nhập hàng, tính toán từ bảng tồn kho:', importError);
            importData = await calculateImportData(dateStr, prevDateStr);
        }
        
        // IDs của các sản phẩm ly cần hiển thị
        const lyProductIds = [162, 163, 164, 165];
        
        // Lọc các sản phẩm ly từ danh sách sản phẩm
        const lyProducts = products.filter(product => 
            lyProductIds.includes(product[0])
        );
        
        // Tạo bảng
        const tbody = document.querySelector('#lyReportTable tbody');
        tbody.innerHTML = '';
        
        // Lặp qua các sản phẩm ly
        lyProducts.forEach((product, index) => {
            const row = document.createElement('tr');
            
            // STT
            const sttCell = document.createElement('td');
            sttCell.textContent = index + 1;
            row.appendChild(sttCell);
            
            // Tên hàng
            const nameCell = document.createElement('td');
            nameCell.textContent = product[2];
            row.appendChild(nameCell);
            
            // Tồn Trước (ngày trước đó)
            const prevInventoryItem = prevInventoryData.find(item => item[2] === product[2]);
            const prevInventory = prevInventoryItem ? prevInventoryItem[3] : 0;
            const prevInventoryCell = document.createElement('td');
            prevInventoryCell.textContent = prevInventory;
            row.appendChild(prevInventoryCell);
            
            // Tồn Nay (ngày hiện tại)
            const currentInventoryItem = currentInventoryData.find(item => item[2] === product[2]);
            const currentInventory = currentInventoryItem ? currentInventoryItem[3] : 0;
            const currentInventoryCell = document.createElement('td');
            currentInventoryCell.textContent = currentInventory;
            row.appendChild(currentInventoryCell);
            
            // Nhập (ngày hiện tại) - Thử nhiều cách tìm kiếm
            let importQuantity = 0;
            
            // Cách 1: Tìm theo tên sản phẩm trực tiếp
            const importItem = importData.find(item => item[2] === product[2]);
            if (importItem) {
                importQuantity = importItem[3] || 0;
            } else {
                // Cách 2: Tìm theo ID sản phẩm
                const importItemById = importData.find(item => {
                    // Kiểm tra xem có trường id_san_pham không
                    if (item.id_san_pham !== undefined) {
                        return item.id_san_pham == product[0];
                    }
                    return false;
                });
                
                if (importItemById) {
                    importQuantity = importItemById.so_luong || importItemById[3] || 0;
                } else {
                    // Cách 3: Tìm theo ten_hang (nếu có)
                    const importItemByName = importData.find(item => {
                        if (item.ten_hang !== undefined) {
                            return item.ten_hang === product[2];
                        }
                        return false;
                    });
                    
                    if (importItemByName) {
                        importQuantity = importItemByName.so_luong || 0;
                    }
                }
            }
            
            // Sử dụng = Tồn Trước - Tồn Nay + Nhập
            const usage = prevInventory - currentInventory + importQuantity;
            const usageCell = document.createElement('td');
            usageCell.textContent = usage;
            row.appendChild(usageCell);
            
            tbody.appendChild(row);
        });
        
        // Ẩn loading
        hideLoading();
    } catch (error) {
        console.error('Error loading ly report:', error);
        showErrorToast('Lỗi khi tải báo cáo ly');
        hideLoading();
    }
}

// Hàm xuất báo cáo ly ra Excel
function exportLyReportToExcel() {
    const selectedDate = document.getElementById('lyReportDate').value;
    let fileName = `BaoCaoLy_${selectedDate}.xlsx`;
    
    // Tạo dữ liệu cho Excel
    const table = document.getElementById('lyReportTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Báo Cáo Ly"});
    
    // Xuất file
    XLSX.writeFile(wb, fileName);
}

// Cập nhật tiến trình import nhập hàng
function updateImportImportProgress(current, total, status = '') {
    const percentage = Math.round((current / total) * 100);
    document.getElementById('importImportProgressText').textContent = `${current}/${total}`;
    document.getElementById('importImportProgressBar').style.width = `${percentage}%`;
    document.getElementById('importImportProgressBar').setAttribute('aria-valuenow', percentage);
    document.getElementById('importImportProgressBar').textContent = `${percentage}%`;
    
    if (status) {
        document.getElementById('importImportStatus').textContent = status;
    }
}

</script>

